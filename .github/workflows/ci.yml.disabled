name: CI for Mail Chart

on:
  push:
    branches:
      - main
    paths:
      - 'mail/**'
      - 'ansible/**'
  pull_request:
    branches:
      - main
    paths:
      - 'mail/**'
      - 'ansible/**'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type de vÃ©rification'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - lint-only
          - security-only

env:
  REGISTRY: ghcr.io
  NAMESPACE_PREFIX: prod

jobs:
  detect-changes:
    name: ğŸ” DÃ©tection des Changements
    runs-on: ubuntu-latest
    outputs:
      mail_changed: ${{ steps.changes.outputs.mail }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: ğŸ” VÃ©rifier l'existence du dossier mail
        run: |
          if [ ! -d "mail" ]; then
            echo "âŒ Erreur : Dossier mail manquant"
            exit 1
          fi
          echo "âœ… Dossier mail existe"
      - name: ğŸ” DÃ©tecter les changements dans mail
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            git fetch origin "${{ github.base_ref }}" --no-tags
            diff_base="${{ github.base_ref }}"
          else
            diff_base="HEAD~1"
          fi
          if git diff --name-only "$diff_base" | grep -q "^mail/"; then
            echo "mail=true" >> "$GITHUB_OUTPUT"
            echo "âœ… Changements dÃ©tectÃ©s dans mail"
          else
            echo "mail=false" >> "$GITHUB_OUTPUT"
            echo "â¸ï¸ Aucun changement dans mail"
          fi

  validate-chart:
    name: ğŸ§ª Validation du Chart Mail
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.mail_changed == 'true' && (github.event.inputs.check_type == 'full' || github.event.inputs.check_type == 'lint-only' || github.event_name != 'workflow_dispatch') }}
    steps:
      - uses: actions/checkout@v4
      - name: âš™ï¸ Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.19.0'
      - name: ğŸ” Validation du chart mail
        run: |
          echo "ğŸ” Validation de mail"
          helm lint ./mail --strict || { echo "âŒ Erreurs de lint dans mail"; exit 1; }
          echo "âœ… Chart mail validÃ©"

  security-audit:
    name: ğŸ”’ Audit de SÃ©curitÃ©
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.mail_changed == 'true' && (github.event.inputs.check_type == 'full' || github.event.inputs.check_type == 'security-only' || github.event_name != 'workflow_dispatch') }}
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ”’ Audit de sÃ©curitÃ© pour mail
        run: |
          echo "ğŸ”’ Audit de sÃ©curitÃ©: mail"
          security_issues=0
          if grep -rn -E "(password|pwd|pass).*:.*['\"][^'\"]*[a-zA-Z0-9]{3,}[^'\"]*['\"]" "mail/" --include="*.yaml" --include="*.yml" | grep -v "passwordSecretRef" | grep -v "{{ .*password" | grep -v "#.*password"; then
            echo "âš ï¸ Mots de passe potentiellement en dur dÃ©tectÃ©s!"
            security_issues=$((security_issues + 1))
          else
            echo "âœ… Pas de mots de passe en dur dÃ©tectÃ©s"
          fi
          if grep -rn -E "(privileged|runAsRoot|allowPrivilegeEscalation).*true" "mail/" --include="*.yaml"; then
            echo "âš ï¸ PrivilÃ¨ges Ã©levÃ©s dÃ©tectÃ©s!"
            security_issues=$((security_issues + 1))
          else
            echo "âœ… Pas de privilÃ¨ges Ã©levÃ©s dÃ©tectÃ©s"
          fi
          if grep -rn -E "image:.*latest" "mail/" --include="*.yaml" | grep -v "{{"; then
            echo "âš ï¸ Images avec tag 'latest' dÃ©tectÃ©es!"
            security_issues=$((security_issues + 1))
          else
            echo "âœ… Pas d'images avec tag 'latest'"
          fi
          if [ $security_issues -eq 0 ]; then
            echo "âœ… Audit sÃ©curitÃ© OK"
          else
            echo "âš ï¸ $security_issues issues de sÃ©curitÃ© dÃ©tectÃ©es"
            exit 1
          fi

  package-chart:
    name: ğŸ“¦ Package du Chart Mail
    runs-on: ubuntu-latest
    needs: [validate-chart, security-audit]
    if: ${{ needs.detect-changes.outputs.mail_changed == 'true' && github.ref == 'refs/heads/main' }}
    steps:
      - uses: actions/checkout@v4
      - name: âš™ï¸ Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.19.0'
      - name: ğŸ“¦ Package le chart mail
        run: |
          mkdir -p artifacts
          helm package ./mail --destination artifacts/ || { echo "âŒ Ã‰chec du packaging pour mail"; exit 1; }
          echo "ğŸ“¦ Chart mail packagÃ©"
      - name: ğŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: helm-charts
          path: artifacts/*.tgz
          retention-days: 7

  final-report:
    name: ğŸ“Š Rapport Final
    runs-on: ubuntu-latest
    needs: [detect-changes, validate-chart, security-audit, package-chart]
    if: always()
    steps:
      - name: ğŸ“Š GÃ©nÃ©ration du rapport
        run: |
          echo "ğŸ“Š === RAPPORT CI ==="
          echo "ğŸ•’ Date: $(date)"
          echo "ğŸŒ¿ Branch: ${{ github.ref }}"
          echo "ğŸ’¾ Commit: ${{ github.sha }}"
          echo "âš™ï¸ Type de vÃ©rification: ${{ github.event.inputs.check_type || 'full' }}"
          echo ""
          echo "ğŸ“‹ === RÃ‰SULTATS ==="
          if [[ "${{ needs.detect-changes.result }}" == "success" ]]; then
            echo "âœ… DÃ©tection des changements: SUCCÃˆS"
          else
            echo "âŒ DÃ©tection des changements: Ã‰CHEC"
          fi
          if [[ "${{ needs.validate-chart.result }}" == "success" ]]; then
            echo "âœ… Validation Chart: SUCCÃˆS"
          elif [[ "${{ needs.validate-chart.result }}" == "skipped" ]]; then
            echo "â¸ï¸ Validation Chart: IGNORÃ‰"
          else
            echo "âŒ Validation Chart: Ã‰CHEC"
          fi
          if [[ "${{ needs.security-audit.result }}" == "success" ]]; then
            echo "âœ… Audit SÃ©curitÃ©: SUCCÃˆS"
          elif [[ "${{ needs.security-audit.result }}" == "skipped" ]]; then
            echo "â¸ï¸ Audit SÃ©curitÃ©: IGNORÃ‰"
          else
            echo "âŒ Audit SÃ©curitÃ©: Ã‰CHEC"
          fi
          if [[ "${{ needs.package-chart.result }}" == "success" ]]; then
            echo "âœ… Packaging Chart: SUCCÃˆS"
          elif [[ "${{ needs.package-chart.result }}" == "skipped" ]]; then
            echo "â¸ï¸ Packaging Chart: IGNORÃ‰"
          else
            echo "âŒ Packaging Chart: Ã‰CHEC"
          fi
          echo ""
          echo "ğŸ¯ === CONCLUSION ==="
          if [[ "${{ needs.validate-chart.result }}" == "success" && "${{ needs.security-audit.result }}" == "success" ]]; then
            echo "ğŸ‰ SUCCÃˆS: Chart mail validÃ© et prÃªt pour dÃ©ploiement !"
          else
            echo "âŒ Ã‰CHEC: RÃ©vision nÃ©cessaire avant dÃ©ploiement"
            exit 1
          fi