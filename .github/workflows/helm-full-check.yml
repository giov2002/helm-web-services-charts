name: ğŸ” Full Helm Charts Validation and Deployment

on:
  # DÃ©clenchement manuel via l'interface GitHub
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type de vÃ©rification'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - security-only
        - lint-only
        - deploy-only
  
  # DÃ©clenchement programmÃ© (tous les lundis Ã  9h00 UTC)
  schedule:
    - cron: '0 9 * * 1'
  
  # DÃ©clenchement sur push vers main
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/helm-full-check.yml'
      - 'ansible/**'
      - 'database/**'
      - 'monitoring/**'
      - 'web-apache/**'
      - 'web-nginx/**'
      - 'unbound/**'
      - 'email/**'
      - 'bind9/**'

env:
  REGISTRY: ghcr.io
  NAMESPACE_PREFIX: prod

jobs:
  # Job 1: PrÃ©paration et inventaire des charts
  prepare-inventory:
    name: ğŸ“‹ Inventaire des Charts
    runs-on: ubuntu-latest
    outputs:
      all_charts: ${{ steps.inventory.outputs.all_charts }}
      charts_count: ${{ steps.inventory.outputs.charts_count }}
    
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ“‹ Inventaire complet des charts
        id: inventory
        run: |
          declare -A services=(
            [bind9]="bind9"
            [mysql]="database/mysql"
            [phpmyadmin]="database/phpmyadmin"
            [email]="email"
            [monitoring]="monitoring/monitoring-chart"
            [unbound]="unbound"
            [web-apache]="web-apache"
            [web-nginx]="web-nginx"
          )

          echo "ğŸ” VÃ©rification de l'existence des charts..."
          charts_found=()
          charts_missing=()

          for svc in "${!services[@]}"; do
            path="${services[$svc]}"
            if [ -d "${path}" ] && [ -f "${path}/Chart.yaml" ]; then
              charts_found+=("$svc")
              echo "âœ… Chart trouvÃ©: $svc (${path})"
            else
              charts_missing+=("$svc")
              echo "âŒ Chart manquant: $svc (${path})"
            fi
          done

          charts_json=$(printf '%s\n' "${charts_found[@]}" | jq -R -s -c 'split("\n")[:-1]')
          echo "all_charts=${charts_json}" >> $GITHUB_OUTPUT
          echo "charts_count=${#charts_found[@]}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ğŸ“Š RÃ‰SUMÃ‰ INVENTAIRE:"
          echo "Charts trouvÃ©s: ${#charts_found[@]}"
          echo "Charts manquants: ${#charts_missing[@]}"
          echo "Charts Ã  vÃ©rifier: ${charts_found[*]}"
          
          if [ ${#charts_missing[@]} -gt 0 ]; then
            echo "âš ï¸ Charts manquants: ${charts_missing[*]}"
            exit 1
          fi

  # Job 2: Validation complÃ¨te des charts
  validate-all-charts:
    name: ğŸ§ª Validation ComplÃ¨te
    runs-on: ubuntu-latest
    needs: prepare-inventory
    if: ${{ needs.prepare-inventory.outputs.charts_count > 0 && (github.event.inputs.check_type == 'full' || github.event.inputs.check_type == 'lint-only' || github.event_name != 'workflow_dispatch') }}
    strategy:
      matrix:
        chart: ${{ fromJson(needs.prepare-inventory.outputs.all_charts) }}
      fail-fast: false
      max-parallel: 4
    
    steps:
      - uses: actions/checkout@v4

      - name: âš™ï¸ Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.15.4'

      - name: ğŸ” Validation approfondie du chart ${{ matrix.chart }}
        run: |
          declare -A paths=(
            [bind9]="bind9"
            [mysql]="database/mysql"
            [phpmyadmin]="database/phpmyadmin"
            [email]="email"
            [monitoring]="monitoring/monitoring-chart"
            [unbound]="unbound"
            [web-apache]="web-apache"
            [web-nginx]="web-nginx"
          )

          chart_path="${paths[${{ matrix.chart }}]}"
          echo "ğŸ” === VALIDATION DE: ${{ matrix.chart }} ==="
          echo "ğŸ“ Chemin: $chart_path"
          
          echo ""
          echo "ğŸ” Helm lint..."
          helm lint "$chart_path" --strict
          
          echo ""
          echo "ğŸ” Helm template (dry-run)..."
          helm template "test-${{ matrix.chart }}" "$chart_path" --dry-run --debug
          
          echo ""
          echo "ğŸ” VÃ©rification des dÃ©pendances..."
          if [ -f "$chart_path/Chart.lock" ]; then
            echo "ğŸ“¦ Chart.lock trouvÃ©"
            helm dependency list "$chart_path" || echo "âš ï¸ Pas de dÃ©pendances externes"
          else
            echo "â„¹ï¸ Pas de Chart.lock - pas de dÃ©pendances externes"
          fi
          
          echo ""
          echo "âœ… ${{ matrix.chart }} validÃ© avec succÃ¨s!"

  # Job 3: Lint YAML complet
  full-yaml-lint:
    name: ğŸ“ Lint YAML Complet
    runs-on: ubuntu-latest
    needs: prepare-inventory
    if: ${{ needs.prepare-inventory.outputs.charts_count > 0 && (github.event.inputs.check_type == 'full' || github.event.inputs.check_type == 'lint-only' || github.event_name != 'workflow_dispatch') }}
    strategy:
      matrix:
        chart: ${{ fromJson(needs.prepare-inventory.outputs.all_charts) }}
      fail-fast: false
    
    steps:
      - uses: actions/checkout@v4

      - name: âš™ï¸ Setup yamllint
        run: sudo apt-get update && sudo apt-get install -y yamllint

      - name: âš™ï¸ Configuration yamllint stricte
        run: |
          cat <<EOF > .yamllint-strict.yaml
          extends: default
          rules:
            line-length:
              max: 120
              level: warning
            indentation:
              spaces: 2
            comments:
              min-spaces-from-content: 1
            truthy:
              allowed-values: ['true', 'false', 'yes', 'no']
            brackets:
              max-spaces-inside: 1
            commas:
              max-spaces-after: 1
            key-duplicates: enable
            empty-lines:
              max-end: 1
          ignore: |
            *.tgz
            */templates/*.tpl
            */.helmignore
          EOF

      - name: ğŸ“ Lint YAML approfondi pour ${{ matrix.chart }}
        run: |
          declare -A paths=(
            [bind9]="bind9"
            [mysql]="database/mysql"
            [phpmyadmin]="database/phpmyadmin"
            [email]="email"
            [monitoring]="monitoring/monitoring-chart"
            [unbound]="unbound"
            [web-apache]="web-apache"
            [web-nginx]="web-nginx"
          )

          chart_path="${paths[${{ matrix.chart }}]}"
          echo "ğŸ“ === LINT YAML: ${{ matrix.chart }} ==="
          
          yaml_files=$(find "$chart_path" -name "*.yaml" -o -name "*.yml" | wc -l)
          echo "ğŸ“„ Fichiers YAML trouvÃ©s: $yaml_files"
          
          if [ $yaml_files -gt 0 ]; then
            echo ""
            echo "ğŸ“ Analyse des fichiers YAML..."
            find "$chart_path" -name "*.yaml" -o -name "*.yml" | while read file; do
              echo "ğŸ” $file"
              yamllint -c .yamllint-strict.yaml "$file" || echo "âš ï¸ Warnings dans $file"
            done
          else
            echo "âš ï¸ Aucun fichier YAML trouvÃ© dans $chart_path"
          fi
          
          echo "âœ… Lint YAML terminÃ© pour ${{ matrix.chart }}"

  # Job 4: Audit de sÃ©curitÃ© complet
  full-security-audit:
    name: ğŸ”’ Audit de SÃ©curitÃ© Complet
    runs-on: ubuntu-latest
    needs: prepare-inventory
    if: ${{ needs.prepare-inventory.outputs.charts_count > 0 && (github.event.inputs.check_type == 'full' || github.event.inputs.check_type == 'security-only' || github.event_name != 'workflow_dispatch') }}
    strategy:
      matrix:
        chart: ${{ fromJson(needs.prepare-inventory.outputs.all_charts) }}
      fail-fast: false
    
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ”’ Audit de sÃ©curitÃ© approfondi pour ${{ matrix.chart }}
        run: |
          declare -A paths=(
            [bind9]="bind9"
            [mysql]="database/mysql"
            [phpmyadmin]="database/phpmyadmin"
            [email]="email"
            [monitoring]="monitoring/monitoring-chart"
            [unbound]="unbound"
            [web-apache]="web-apache"
            [web-nginx]="web-nginx"
          )

          chart_path="${paths[${{ matrix.chart }}]}"
          echo "ğŸ”’ === AUDIT SÃ‰CURITÃ‰: ${{ matrix.chart }} ==="
          
          security_issues=0
          
          echo ""
          echo "ğŸ” VÃ©rification des mots de passe en dur..."
          if grep -rn -E "(password|pwd|pass).*:.*['\"][^'\"]*[a-zA-Z0-9]{3,}[^'\"]*['\"]" "$chart_path/" --include="*.yaml" --include="*.yml" | grep -v "passwordSecretRef" | grep -v "{{ .*password" | grep -v "#.*password"; then
            echo "âš ï¸ Mots de passe potentiellement en dur dÃ©tectÃ©s!"
            security_issues=$((security_issues + 1))
          else
            echo "âœ… Pas de mots de passe en dur dÃ©tectÃ©s"
          fi
          
          echo ""
          echo "ğŸ” VÃ©rification de l'utilisation des secrets..."
          if find "$chart_path" -name "*.yaml" -exec grep -l "kind: Secret" {} \; | head -5; then
            echo "ğŸ“‹ Secrets trouvÃ©s - vÃ©rification de la structure..."
            find "$chart_path" -name "*.yaml" -exec grep -A5 -B2 "kind: Secret" {} \;
          else
            echo "â„¹ï¸ Aucun secret Kubernetes dÃ©fini"
          fi
          
          echo ""
          echo "ğŸ” VÃ©rification des privilÃ¨ges de sÃ©curitÃ©..."
          if grep -rn -E "(privileged|runAsRoot|allowPrivilegeEscalation).*true" "$chart_path/" --include="*.yaml"; then
            echo "âš ï¸ PrivilÃ¨ges Ã©levÃ©s dÃ©tectÃ©s!"
            security_issues=$((security_issues + 1))
          else
            echo "âœ… Pas de privilÃ¨ges Ã©levÃ©s dÃ©tectÃ©s"
          fi
          
          echo ""
          echo "ğŸ” VÃ©rification des images Docker..."
          if grep -rn -E "image:.*latest" "$chart_path/" --include="*.yaml" | grep -v "{{"; then
            echo "âš ï¸ Images avec tag 'latest' dÃ©tectÃ©es!"
            security_issues=$((security_issues + 1))
          else
            echo "âœ… Pas d'images avec tag 'latest'"
          fi
          
          echo ""
          echo "ğŸ“Š === RÃ‰SUMÃ‰ SÃ‰CURITÃ‰ ==="
          echo "Issues trouvÃ©es: $security_issues"
          if [ $security_issues -eq 0 ]; then
            echo "âœ… ${{ matrix.chart }} - Audit sÃ©curitÃ© OK"
          else
            echo "âš ï¸ ${{ matrix.chart }} - $security_issues issues Ã  vÃ©rifier"
          fi

  # Job 5: Test de rendu des templates
  template-rendering:
    name: ğŸ¨ Test de Rendu des Templates
    runs-on: ubuntu-latest
    needs: prepare-inventory
    if: ${{ needs.prepare-inventory.outputs.charts_count > 0 && (github.event.inputs.check_type == 'full' || github.event_name != 'workflow_dispatch') }}
    strategy:
      matrix:
        chart: ${{ fromJson(needs.prepare-inventory.outputs.all_charts) }}
      fail-fast: false
    
    steps:
      - uses: actions/checkout@v4

      - name: âš™ï¸ Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.15.4'

      - name: ğŸ¨ Test de rendu pour ${{ matrix.chart }}
        run: |
          declare -A paths=(
            [bind9]="bind9"
            [mysql]="database/mysql"
            [phpmyadmin]="database/phpmyadmin"
            [email]="email"
            [monitoring]="monitoring/monitoring-chart"
            [unbound]="unbound"
            [web-apache]="web-apache"
            [web-nginx]="web-nginx"
          )

          chart_path="${paths[${{ matrix.chart }}]}"
          echo "ğŸ¨ === TEST RENDU: ${{ matrix.chart }} ==="
          
          echo ""
          echo "ğŸ” Test rendu par dÃ©faut..."
          helm template "test-${{ matrix.chart }}" "$chart_path" > "/tmp/render-${{ matrix.chart }}.yaml"
          
          echo "ğŸ“„ Objets Kubernetes gÃ©nÃ©rÃ©s:"
          grep -c "^kind:" "/tmp/render-${{ matrix.chart }}.yaml" || echo "0"
          
          echo ""
          echo "ğŸ“‹ Types d'objets:"
          grep "^kind:" "/tmp/render-${{ matrix.chart }}.yaml" | sort | uniq -c || echo "Aucun objet"
          
          echo ""
          echo "ğŸ” VÃ©rification des ressources essentielles..."
          
          if grep -q "kind: Deployment" "/tmp/render-${{ matrix.chart }}.yaml"; then
            echo "âœ… Deployment trouvÃ©"
          elif grep -q "kind: StatefulSet" "/tmp/render-${{ matrix.chart }}.yaml"; then
            echo "âœ… StatefulSet trouvÃ©"
          else
            echo "âš ï¸ Aucun Deployment/StatefulSet trouvÃ©"
          fi
          
          if grep -q "kind: Service" "/tmp/render-${{ matrix.chart }}.yaml"; then
            echo "âœ… Service trouvÃ©"
          else
            echo "â„¹ï¸ Aucun Service trouvÃ©"
          fi
          
          echo "âœ… Test de rendu terminÃ© pour ${{ matrix.chart }}"

  # Job 6: DÃ©ploiement des charts via Ansible
  deploy-charts:
    name: ğŸš€ DÃ©ploiement des Charts
    runs-on: ubuntu-latest
    needs: [prepare-inventory, validate-all-charts, template-rendering]
    if: ${{ needs.prepare-inventory.outputs.charts_count > 0 && (github.event.inputs.check_type == 'full' || github.event.inputs.check_type == 'deploy-only' || github.event_name == 'push' || github.event_name == 'schedule') }}
    steps:
      - uses: actions/checkout@v4

      - name: âš™ï¸ Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.15.4'

      - name: âš™ï¸ Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.33.1'

      - name: âš™ï¸ Install Ansible and dependencies
        run: |
         sudo apt update
         sudo apt install -y python3-pip
         pip3 install --upgrade pip
         pip3 install ansible kubernetes
         /opt/pipx/venvs/ansible-core/bin/pip install kubernetes  # Installe dans l'environnement pipx
         ansible-galaxy collection install kubernetes.core:2.4.0
      - name: âš™ï¸ Install Helm Diff plugin
        run: |
         helm plugin install https://github.com/databus23/helm-diff --version v3.9.11
      - name: ğŸš€ Start Minikube
        run: |
         minikube start --driver=docker --cpus=4 --memory=8192
         eval $(minikube docker-env)
      - name: ğŸš€ Run Ansible Playbook
        run: |
         cd ansible
         ansible-playbook minikube-cd-deploy.yml -e "ansible_python_interpreter=/usr/bin/python3"
        env:
         GITHUB_PAT: ${{ secrets.GITHUB_PAT }}
      - name: âœ… Verify deployments
        run: |
         kubectl get pods --all-namespaces
         kubectl get services --all-namespaces
         kubectl get namespaces

  # Job 7: Rapport final complet
  final-report:
    name: ğŸ“Š Rapport Final Complet
    runs-on: ubuntu-latest
    needs: [prepare-inventory, validate-all-charts, full-yaml-lint, full-security-audit, template-rendering, deploy-charts]
    if: always()
    
    steps:
      - name: ğŸ“Š GÃ©nÃ©ration du rapport complet
        run: |
          echo "ğŸ“Š === RAPPORT COMPLET CI/CD HELM CHARTS ==="
          echo "ğŸ•’ Date: $(date)"
          echo "ğŸŒ¿ Branch: ${{ github.ref }}"
          echo "ğŸ’¾ Commit: ${{ github.sha }}"
          echo "ğŸš€ DÃ©clencheur: ${{ github.event.inputs.triggered_by || github.event_name }}"
          echo "âš™ï¸ Type de vÃ©rification: ${{ github.event.inputs.check_type || 'full' }}"
          
          echo ""
          echo "ğŸ“‹ === INVENTAIRE ==="
          echo "Charts dÃ©tectÃ©s: ${{ needs.prepare-inventory.outputs.charts_count }}"
          echo "Charts analysÃ©s: $(echo '${{ needs.prepare-inventory.outputs.all_charts }}' | jq -r '. | join(", ")')"
          
          echo ""
          echo "ğŸ“Š === RÃ‰SULTATS PAR JOB ==="
          
          if [[ "${{ needs.prepare-inventory.result }}" == "success" ]]; then
            echo "âœ… Inventaire: SUCCÃˆS"
          else
            echo "âŒ Inventaire: Ã‰CHEC"
          fi
          
          if [[ "${{ needs.validate-all-charts.result }}" == "success" ]]; then
            echo "âœ… Validation Charts: SUCCÃˆS"
          elif [[ "${{ needs.validate-all-charts.result }}" == "skipped" ]]; then
            echo "â¸ï¸ Validation Charts: IGNORÃ‰"
          else
            echo "âŒ Validation Charts: Ã‰CHEC"
          fi
          
          if [[ "${{ needs.full-yaml-lint.result }}" == "success" ]]; then
            echo "âœ… Lint YAML: SUCCÃˆS"
          elif [[ "${{ needs.full-yaml-lint.result }}" == "skipped" ]]; then
            echo "â¸ï¸ Lint YAML: IGNORÃ‰"
          else
            echo "âŒ Lint YAML: Ã‰CHEC"
          fi
          
          if [[ "${{ needs.full-security-audit.result }}" == "success" ]]; then
            echo "âœ… Audit SÃ©curitÃ©: SUCCÃˆS"
          elif [[ "${{ needs.full-security-audit.result }}" == "skipped" ]]; then
            echo "â¸ï¸ Audit SÃ©curitÃ©: IGNORÃ‰"
          else
            echo "âŒ Audit SÃ©curitÃ©: Ã‰CHEC"
          fi
          
          if [[ "${{ needs.template-rendering.result }}" == "success" ]]; then
            echo "âœ… Test Templates: SUCCÃˆS"
          elif [[ "${{ needs.template-rendering.result }}" == "skipped" ]]; then
            echo "â¸ï¸ Test Templates: IGNORÃ‰"
          else
            echo "âŒ Test Templates: Ã‰CHEC"
          fi
          
          if [[ "${{ needs.deploy-charts.result }}" == "success" ]]; then
            echo "âœ… DÃ©ploiement Charts: SUCCÃˆS"
          elif [[ "${{ needs.deploy-charts.result }}" == "skipped" ]]; then
            echo "â¸ï¸ DÃ©ploiement Charts: IGNORÃ‰"
          else
            echo "âŒ DÃ©ploiement Charts: Ã‰CHEC"
          fi
          
          echo ""
          echo "ğŸ¯ === RECOMMANDATIONS ==="
          echo "â€¢ VÃ©rifiez les warnings YAML si prÃ©sents"
          echo "â€¢ Examinez les issues de sÃ©curitÃ© signalÃ©es"
          echo "â€¢ Assurez-vous que tous les charts ont les ressources nÃ©cessaires"
          echo "â€¢ Utilisez des tags d'images spÃ©cifiques (Ã©vitez 'latest')"
          echo "â€¢ VÃ©rifiez les logs des pods pour les dÃ©ploiements Ã©chouÃ©s"
          
          echo ""
          echo "ğŸš€ === CONCLUSION ==="

      - name: ğŸ¯ DÃ©termination du statut final
        run: |
          critical_failures=0
          
          if [[ "${{ needs.prepare-inventory.result }}" != "success" ]]; then
            critical_failures=$((critical_failures + 1))
            echo "âŒ Inventaire en Ã©chec"
          fi
          
          if [[ "${{ needs.validate-all-charts.result }}" == "failure" ]]; then
            critical_failures=$((critical_failures + 1))
            echo "âŒ Validation en Ã©chec"
          fi
          
          if [[ "${{ needs.deploy-charts.result }}" == "failure" ]]; then
            critical_failures=$((critical_failures + 1))
            echo "âŒ DÃ©ploiement en Ã©chec"
          fi
          
          if [ $critical_failures -eq 0 ]; then
            echo ""
            echo "ğŸ‰ === SUCCÃˆS GLOBAL ==="
            echo "âœ… Tous les charts ont passÃ© les vÃ©rifications critiques et ont Ã©tÃ© dÃ©ployÃ©s!"
            echo "ğŸš€ Vos charts Helm sont opÃ©rationnels!"
          else
            echo ""
            echo "ğŸ’¥ === Ã‰CHEC GLOBAL ==="
            echo "âŒ $critical_failures vÃ©rifications critiques ont Ã©chouÃ©"
            echo "ğŸ”§ Une rÃ©vision est nÃ©cessaire avant le dÃ©ploiement"
            exit 1
          fi