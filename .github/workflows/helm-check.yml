name: ðŸš€ CI Helm Charts

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'web-nginx/**'
      - 'monitoring/**'
      - 'web-apache/**'
      - 'bind9/**'
      - 'database/**'
      - 'mailserver/**'
      - 'roundcube/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'web-nginx/**'
      - 'monitoring/**'
      - 'web-apache/**'
      - 'bind9/**'
      - 'database/**'
      - 'mailserver/**'
      - 'roundcube/**'

env:
  REGISTRY: ghcr.io
  NAMESPACE_PREFIX: prod

jobs:
  # Job 1: DÃ©tection des services modifiÃ©s
  detect-changes:
    name: ðŸ” DÃ©tection des Changements
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.changes.outputs.charts }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ” DÃ©tecter les changements par service
      id: changes
      run: |
        charts_changed=""
        
        check_changes() {
          local service=$1
          local path=$2
          if git diff --name-only HEAD~1 | grep -q "^${path}/"; then
            echo "${service}=true" >> $GITHUB_OUTPUT
            charts_changed="${charts_changed},${service}"
            echo "âœ… Changements dÃ©tectÃ©s dans: $service"
          else
            echo "${service}=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸ Aucun changement dans: $service"
          fi
        }

        check_changes "bind9" "bind9"
        check_changes "mysql" "database/mysql"
        check_changes "phpmyadmin" "database/phpmyadmin"
        check_changes "mailserver" "mailserver"
        check_changes "monitoring" "monitoring"
        check_changes "roundcube" "roundcube"
        check_changes "web-apache" "web-apache"
        check_changes "web-nginx" "web-nginx"

        charts_changed=$(echo "$charts_changed" | sed 's/^,//')
        echo "charts=${charts_changed}" >> $GITHUB_OUTPUT
        echo "ðŸ“‹ Services modifiÃ©s: $charts_changed"

  # Job 2: Validation Helm complÃ¨te
  validate-charts:
    name: ðŸ§ª Validation Helm Charts
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.charts != '' }}
    strategy:
      matrix:
        chart: ${{ fromJson(format('[{0}]', needs.detect-changes.outputs.charts)) }}
      fail-fast: false
    
    steps:
    - uses: actions/checkout@v4

    - name: âš™ï¸ Installer Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'

    - name: âš¡ Installer yamllint
      run: |
        sudo apt-get update
        sudo apt-get install -y yamllint

    - name: ðŸ” Validation du chart ${{ matrix.chart }}
      run: |
        # DÃ©finir le chemin du chart
        chart_path=""
        case "${{ matrix.chart }}" in
          "mysql") chart_path="database/mysql" ;;
          "phpmyadmin") chart_path="database/phpmyadmin" ;;
          "monitoring") chart_path="monitoring/monitoring-chart" ;;
          *) chart_path="${{ matrix.chart }}" ;;
        esac
        
        echo "ðŸ” Validation de: $chart_path"

        # Lint et Dry-run
        helm lint $chart_path/
        helm template test-${{ matrix.chart }} $chart_path/ --dry-run

        # YAML lint pour tous les fichiers YAML
        yamllint $chart_path/

        # VÃ©rification des ressources
        if helm template test $chart_path/ | grep -q "resources:"; then
          echo "âœ… Limites de ressources dÃ©finies"
        else
          echo "âš ï¸ Ressources non dÃ©finies"
        fi

        # VÃ©rification des secrets
        if grep -r "password.*:" "$chart_path/" --include="*.yaml" | grep -v "passwordSecretRef" | grep -v "# Example"; then
          echo "âš ï¸ Secrets potentiellement en dur trouvÃ©s"
        else
          echo "âœ… Secrets correctement gÃ©rÃ©s"
        fi

        # VÃ©rification des images
        images=$(helm template test $chart_path/ | grep "image:" | awk '{print $2}' | sort | uniq)
        for img in $images; do
          if [[ "$img" == *":latest" ]] || [[ "$img" != *:* ]]; then
            echo "âš ï¸ Image non taggÃ©e ou latest: $img"
          else
            echo "âœ… Image ok: $img"
          fi
        done

        # VÃ©rification des labels Kubernetes standards
        labels=$(helm template test $chart_path/ | grep -E "app.kubernetes.io/(name|version|managed-by):")
        if [ -z "$labels" ]; then
          echo "âš ï¸ Labels standard Kubernetes manquants"
        else
          echo "âœ… Labels standard prÃ©sents"
          echo "$labels"
        fi

        # VÃ©rification des dÃ©pendances
        if [ -f "$chart_path/Chart.yaml" ]; then
          helm dependency update $chart_path/
          helm dep list $chart_path/
        fi

    - name: ðŸ“‹ RÃ©sumÃ© pour ${{ matrix.chart }}
      run: |
        echo "âœ… Validation CI terminÃ©e pour ${{ matrix.chart }}"

  # Job 3: Rapport global CI
  report:
    name: ðŸ“Š Rapport CI
    runs-on: ubuntu-latest
    needs: validate-charts
    if: ${{ needs.detect-changes.outputs.charts != '' }}
    
    steps:
    - name: ðŸ“Š GÃ©nÃ©rer un rapport CI
      run: |
        echo "ðŸ“‹ === RAPPORT CI HELM ===" > ci_report.md
        echo "Date: $(date)" >> ci_report.md
        echo "Branch: ${{ github.ref }}" >> ci_report.md
        echo "Commit: ${{ github.sha }}" >> ci_report.md
        echo "Services modifiÃ©s: ${{ needs.detect-changes.outputs.charts }}" >> ci_report.md
        echo "" >> ci_report.md
        echo "âœ… Chaque chart a Ã©tÃ© lintÃ© et dry-run validÃ©, YAML vÃ©rifiÃ©, secrets et images analysÃ©s." >> ci_report.md
        cat ci_report.md
