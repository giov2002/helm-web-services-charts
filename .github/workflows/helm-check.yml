name: ğŸš€ CI Infrastructure Services

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'bind9/**'
      - 'database/**'
      - 'mailserver/**'
      - 'monitoring/**'
      - 'roundcube/**'
      - 'web-apache/**'
      - 'web-nginx/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'bind9/**'
      - 'database/**'
      - 'mailserver/**'
      - 'monitoring/**'
      - 'roundcube/**'
      - 'web-apache/**'
      - 'web-nginx/**'

env:
  REGISTRY: ghcr.io
  NAMESPACE_PREFIX: prod

jobs:
  # Job 1: DÃ©tection des services modifiÃ©s
  detect-changes:
    name: ğŸ” DÃ©tection des Changements
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.changes.outputs.charts }}
      bind9: ${{ steps.changes.outputs.bind9 }}
      mysql: ${{ steps.changes.outputs.mysql }}
      phpmyadmin: ${{ steps.changes.outputs.phpmyadmin }}
      mailserver: ${{ steps.changes.outputs.mailserver }}
      monitoring: ${{ steps.changes.outputs.monitoring }}
      roundcube: ${{ steps.changes.outputs.roundcube }}
      web-apache: ${{ steps.changes.outputs.web-apache }}
      web-nginx: ${{ steps.changes.outputs.web-nginx }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” DÃ©tecter les changements par service
        id: changes
        run: |
          declare -A services=(
            [bind9]="bind9"
            [mysql]="database/mysql"
            [phpmyadmin]="database/phpmyadmin"
            [mailserver]="mailserver"
            [monitoring]="monitoring/monitoring-chart"
            [roundcube]="roundcube"
            [web-apache]="web-apache"
            [web-nginx]="web-nginx"
          )

          charts_changed=()

          # Utiliser une comparaison adaptÃ©e aux PR et push
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}
            diff_base="${{ github.base_ref }}"
          else
            diff_base="HEAD~1"
          fi

          for svc in "${!services[@]}"; do
            path="${services[$svc]}"
            if git diff --name-only "$diff_base" | grep -q "^${path}/"; then
              echo "$svc=true" >> $GITHUB_OUTPUT
              charts_changed+=("$svc")
              echo "âœ… Changements dÃ©tectÃ©s dans: $svc"
            else
              echo "$svc=false" >> $GITHUB_OUTPUT
              echo "â¸ï¸ Aucun changement dans: $svc"
            fi
          done

          # Exporter la liste JSON pour matrice
          charts_json=$(printf '%s\n' "${charts_changed[@]}" | jq -R -s -c 'split("\n")[:-1]')
          echo "charts=${charts_json}" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Services Ã  dÃ©ployer: ${charts_changed[*]}"

  # Job 2: Validation des charts modifiÃ©s
  validate-charts:
    name: ğŸ§ª Validation des Charts
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.charts != '[]' }}
    strategy:
      matrix:
        chart: ${{ fromJson(needs.detect-changes.outputs.charts) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: âš™ï¸ Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'

      - name: ğŸ” Validation du chart ${{ matrix.chart }}
        run: |
          declare -A paths=(
            [mysql]="database/mysql"
            [phpmyadmin]="database/phpmyadmin"
            [monitoring]="monitoring/monitoring-chart"
            [bind9]="bind9"
            [mailserver]="mailserver"
            [roundcube]="roundcube"
            [web-apache]="web-apache"
            [web-nginx]="web-nginx"
          )

          chart_path="${paths[${{ matrix.chart }}]}"
          echo "ğŸ” Validation de: $chart_path"
          helm lint "$chart_path" --strict
          helm template "test-${{ matrix.chart }}" "$chart_path" --dry-run
          echo "âœ… ${{ matrix.chart }} validÃ©"

  # Job 3: Lint YAML et Kubernetes (Ajout pour CI renforcÃ©e)
  lint-yaml-k8s:
    name: ğŸ“ Lint YAML & K8s
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.charts != '[]' }}
    strategy:
      matrix:
        chart: ${{ fromJson(needs.detect-changes.outputs.charts) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: âš™ï¸ Setup yamllint
        run: sudo apt-get update && sudo apt-get install -y yamllint

      - name: âš™ï¸ Setup kube-linter
        run: |
          curl -L https://github.com/stackrox/kube-linter/releases/download/v0.6.4/kube-linter-linux-amd64.tar.gz | tar xz
          sudo mv kube-linter /usr/local/bin/

      - name: ğŸ“ Lint YAML pour ${{ matrix.chart }}
        run: |
          declare -A paths=(
            [mysql]="database/mysql"
            [phpmyadmin]="database/phpmyadmin"
            [monitoring]="monitoring/monitoring-chart"
            [bind9]="bind9"
            [mailserver]="mailserver"
            [roundcube]="roundcube"
            [web-apache]="web-apache"
            [web-nginx]="web-nginx"
          )

          chart_path="${paths[${{ matrix.chart }}]}"
          echo "ğŸ“ Lint YAML dans: $chart_path"
          find "$chart_path" -name "*.yaml" -exec yamllint {} \;
          echo "âœ… YAML lint passÃ©"

      - name: ğŸ”’ Lint Kubernetes pour ${{ matrix.chart }}
        run: |
          declare -A paths=(
            [mysql]="database/mysql"
            [phpmyadmin]="database/phpmyadmin"
            [monitoring]="monitoring/monitoring-chart"
            [bind9]="bind9"
            [mailserver]="mailserver"
            [roundcube]="roundcube"
            [web-apache]="web-apache"
            [web-nginx]="web-nginx"
          )

          chart_path="${paths[${{ matrix.chart }}]}"
          echo "ğŸ”’ Lint K8s dans: $chart_path"
          helm template "test-${{ matrix.chart }}" "$chart_path" | kube-linter lint -
          echo "âœ… K8s lint passÃ©"

  # Job 4: Audit de SÃ©curitÃ© (SimplifiÃ© pour CI, sans dÃ©ploiement)
  security-audit:
    name: ğŸ”’ Audit de SÃ©curitÃ©
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.charts != '[]' }}
    strategy:
      matrix:
        chart: ${{ fromJson(needs.detect-changes.outputs.charts) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: âš™ï¸ Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'

      - name: ğŸ”’ VÃ©rification des secrets et ressources pour ${{ matrix.chart }}
        run: |
          declare -A paths=(
            [mysql]="database/mysql"
            [phpmyadmin]="database/phpmyadmin"
            [monitoring]="monitoring/monitoring-chart"
            [bind9]="bind9"
            [mailserver]="mailserver"
            [roundcube]="roundcube"
            [web-apache]="web-apache"
            [web-nginx]="web-nginx"
          )

          chart_path="${paths[${{ matrix.chart }}]}"
          echo "ğŸ”’ Audit de: $chart_path"

          # VÃ©rification des mots de passe en dur
          if grep -rE "password.*:.*[a-zA-Z0-9]" "$chart_path/" --include="*.yaml" --exclude="*.tpl" | grep -v "passwordSecretRef" | grep -v "#"; then
            echo "âš ï¸ Mots de passe potentiellement en dur dÃ©tectÃ©s"
            exit 1
          else
            echo "âœ… Pas de mots de passe en dur"
          fi

          # VÃ©rification des limites de ressources
          if helm template "test-${{ matrix.chart }}" "$chart_path" | grep -q "resources:"; then
            echo "âœ… Limites de ressources dÃ©finies"
          else
            echo "âš ï¸ Limites de ressources manquantes"
            exit 1
          fi

  # Job 5: Package Charts (Ajout pour CI : Packaging pour futur dÃ©ploiement)
  package-charts:
    name: ğŸ“¦ Package des Charts
    runs-on: ubuntu-latest
    needs: [validate-charts, lint-yaml-k8s, security-audit]
    if: ${{ needs.detect-changes.outputs.charts != '[]' && github.ref == 'refs/heads/main' }}  # Seulement sur main pour simuler une release CI
    steps:
      - uses: actions/checkout@v4

      - name: âš™ï¸ Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'

      - name: ğŸ“¦ Package les charts modifiÃ©s
        run: |
          declare -A paths=(
            [mysql]="database/mysql"
            [phpmyadmin]="database/phpmyadmin"
            [monitoring]="monitoring/monitoring-chart"
            [bind9]="bind9"
            [mailserver]="mailserver"
            [roundcube]="roundcube"
            [web-apache]="web-apache"
            [web-nginx]="web-nginx"
          )

          for chart in $(echo ${{ needs.detect-changes.outputs.charts }} | jq -r '.[]'); do
            chart_path="${paths[$chart]}"
            helm package "$chart_path" --destination artifacts/
            echo "ğŸ“¦ $chart packagÃ©"
          done

      - name: ğŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: helm-charts
          path: artifacts/*.tgz

  # Job 6: Notification (SimplifiÃ©e pour CI)
  notification:
    name: ğŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [validate-charts, lint-yaml-k8s, security-audit, package-charts]
    if: always()
    steps:
      - name: ğŸ“Š PrÃ©parer le rapport
        run: |
          echo "ğŸ“Š === RAPPORT CI ===" > ci_report.md
          echo "Date: $(date)" >> ci_report.md
          echo "Branch: ${{ github.ref }}" >> ci_report.md
          echo "Commit: ${{ github.sha }}" >> ci_report.md
          echo "" >> ci_report.md
          
          if [[ "${{ needs.validate-charts.result }}" == "success" ]]; then
            echo "âœ… Validation Charts: SUCCÃˆS" >> ci_report.md
          else
            echo "âŒ Validation Charts: Ã‰CHEC" >> ci_report.md
          fi
          
          if [[ "${{ needs.lint-yaml-k8s.result }}" == "success" ]]; then
            echo "âœ… Lint YAML/K8s: SUCCÃˆS" >> ci_report.md
          else
            echo "âŒ Lint YAML/K8s: Ã‰CHEC" >> ci_report.md
          fi
          
          if [[ "${{ needs.security-audit.result }}" == "success" ]]; then
            echo "âœ… Audit SÃ©curitÃ©: SUCCÃˆS" >> ci_report.md
          else
            echo "âŒ Audit SÃ©curitÃ©: Ã‰CHEC" >> ci_report.md
          fi
          
          if [[ "${{ needs.package-charts.result }}" == "success" ]]; then
            echo "âœ… Packaging: SUCCÃˆS" >> ci_report.md
          else
            echo "âŒ Packaging: Ã‰CHEC (ou non lancÃ©)" >> ci_report.md
          fi
          
          echo "" >> ci_report.md
          echo "ğŸš€ CI terminÃ© - PrÃªt pour revue!" >> ci_report.md
          
          cat ci_report.md

      - name: ğŸ“¢ RÃ©sultat final
        run: |
          if [[ "${{ needs.validate-charts.result }}" == "success" && "${{ needs.lint-yaml-k8s.result }}" == "success" && "${{ needs.security-audit.result }}" == "success" ]]; then
            echo "ğŸ‰ SUCCÃˆS: Tous les checks CI sont passÃ©s!"
          else
            echo "âŒ Ã‰CHEC: Certains checks ont Ã©chouÃ© - RÃ©vision nÃ©cessaire"
            exit 1
          fi
