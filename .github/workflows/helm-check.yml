name: ğŸ” VÃ©rification des Charts Helm

# Se dÃ©clenche uniquement lorsque des modifications sont effectuÃ©es dans un sous-dossier spÃ©cifique d'un chart
on:
  push:
    paths:
      - 'web-nginx/**'  # Se dÃ©clenche uniquement si quelque chose change dans le dossier web-nginx/
      - 'monitoring/**'  # Se dÃ©clenche uniquement si quelque chose change dans le dossier monitoring/
      - 'web-apache/**'  # Se dÃ©clenche uniquement si quelque chose change dans le dossier web-apache/
      - 'bind9/**'  # Se dÃ©clenche uniquement si quelque chose change dans le dossier bind9/
      - 'database/**'  # Se dÃ©clenche uniquement si quelque chose change dans le dossier database/
      - 'mailserver/**'  # Se dÃ©clenche uniquement si quelque chose change dans le dossier mailserver/
      - 'roundcube/**'  # Se dÃ©clenche uniquement si quelque chose change dans le dossier roundcube/

  pull_request:
    paths:
      - 'web-nginx/**'
      - 'monitoring/**'
      - 'web-apache/**'
      - 'bind9/**'
      - 'database/**'
      - 'mailserver/**'
      - 'roundcube/**'

jobs:
  check-helm-charts:
    name: VÃ©rification des Charts Helm
    runs-on: ubuntu-latest  # Machine virtuelle Ubuntu gratuite
    
    steps:
    # 1ï¸âƒ£ RÃ©cupÃ©rer le code depuis GitHub
    - name: ğŸ“¥ RÃ©cupÃ©rer le code
      uses: actions/checkout@v4

    # 2ï¸âƒ£ Installer Helm sur la machine virtuelle
    - name: âš™ï¸ Installer Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'

    # 3ï¸âƒ£ VÃ©rifier le chart web-nginx
    - name: ğŸ” VÃ©rifier le chart web-nginx
      run: |
        echo "=== VÃ©rification du chart web-nginx ==="
        echo "ğŸ“ Fichiers dans le chart :"
        ls -la web-nginx/
        
        echo "ğŸ” Lint du chart (recherche d'erreurs) :"
        helm lint web-nginx/
        
        echo "ğŸ§ª Test de gÃ©nÃ©ration des templates :"
        helm template test-nginx web-nginx/ --dry-run

    # 4ï¸âƒ£ VÃ©rifier le chart monitoring
    - name: ğŸ” VÃ©rifier le chart monitoring
      run: |
        echo "=== VÃ©rification du chart monitoring ==="
        echo "ğŸ“ Fichiers dans le chart :"
        ls -la monitoring/monitoring-chart/
        
        echo "ğŸ” Lint du chart (recherche d'erreurs) :"
        helm lint monitoring/monitoring-chart/
        
        echo "ğŸ§ª Test de gÃ©nÃ©ration des templates :"
        helm template test-monitoring monitoring/monitoring-chart/ --dry-run

    # 5ï¸âƒ£ RÃ©sumÃ© final
    - name: âœ… RÃ©sumÃ©
      run: |
        echo "ğŸ‰ Tous les checks sont passÃ©s !"
        echo "Vos charts Helm sont valides et prÃªts Ã  Ãªtre dÃ©ployÃ©s."
