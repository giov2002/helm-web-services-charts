name: ğŸš€ CI/CD Infrastructure Services

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'web-nginx/**'
      - 'monitoring/**'
      - 'web-apache/**'
      - 'bind9/**'
      - 'database/**'
      - 'mailserver/**'
      - 'roundcube/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'web-nginx/**'
      - 'monitoring/**'
      - 'web-apache/**'
      - 'bind9/**'
      - 'database/**'
      - 'mailserver/**'
      - 'roundcube/**'

env:
  REGISTRY: ghcr.io
  NAMESPACE_PREFIX: prod

jobs:
  # Job 1: DÃ©tection des services modifiÃ©s
  detect-changes:
    name: ğŸ” DÃ©tection des Changements
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.changes.outputs.charts }}
      bind9: ${{ steps.changes.outputs.bind9 }}
      mysql: ${{ steps.changes.outputs.mysql }}
      phpmyadmin: ${{ steps.changes.outputs.phpmyadmin }}
      mailserver: ${{ steps.changes.outputs.mailserver }}
      monitoring: ${{ steps.changes.outputs.monitoring }}
      roundcube: ${{ steps.changes.outputs.roundcube }}
      web-apache: ${{ steps.changes.outputs.web-apache }}
      web-nginx: ${{ steps.changes.outputs.web-nginx }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ” DÃ©tecter les changements par service
      id: changes
      run: |
        charts_changed=""
        
        # Fonction pour dÃ©tecter les changements
        check_changes() {
          local service=$1
          local path=$2
          if git diff --name-only HEAD~1 | grep -q "^${path}/"; then
            echo "${service}=true" >> $GITHUB_OUTPUT
            charts_changed="${charts_changed},${service}"
            echo "âœ… Changements dÃ©tectÃ©s dans: $service"
          else
            echo "${service}=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸ Aucun changement dans: $service"
          fi
        }
        
        # VÃ©rification par service
        check_changes "bind9" "bind9"
        check_changes "mysql" "database/mysql"
        check_changes "phpmyadmin" "database/phpmyadmin"
        check_changes "mailserver" "mailserver"
        check_changes "monitoring" "monitoring"
        check_changes "roundcube" "roundcube"
        check_changes "web-apache" "web-apache"
        check_changes "web-nginx" "web-nginx"
        
        # Nettoyer la liste
        charts_changed=$(echo "$charts_changed" | sed 's/^,//')
        echo "charts=${charts_changed}" >> $GITHUB_OUTPUT
        echo "ğŸ“‹ Services Ã  dÃ©ployer: $charts_changed"

  # Job 2: Validation des charts modifiÃ©s
  validate-charts:
    name: ğŸ§ª Validation des Charts
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.charts != '' }}  # VÃ©rifie que la liste des charts n'est pas vide
    strategy:
      matrix:
        chart: ${{ fromJson('[\"' + needs.detect-changes.outputs.charts.replace(',', '","') + '\"]') }}  # Correction de format JSON
      fail-fast: false
    
    steps:
    - uses: actions/checkout@v4

    - name: âš™ï¸ Setup Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'

    - name: ğŸ” Validation du chart ${{ matrix.chart }}
      run: |
        chart_path=""
        case "${{ matrix.chart }}" in
          "mysql") chart_path="database/mysql" ;;
          "phpmyadmin") chart_path="database/phpmyadmin" ;;
          "monitoring") chart_path="monitoring/monitoring-chart" ;;
          *) chart_path="${{ matrix.chart }}" ;;
        esac
        
        echo "ğŸ” Validation de: $chart_path"
        helm lint $chart_path/
        helm template test-${{ matrix.chart }} $chart_path/ --dry-run
        echo "âœ… ${{ matrix.chart }} validÃ©"

  # Job 3: Tests d'intÃ©gration avec ordre de dÃ©ploiement
  integration-tests:
    name: ğŸ”„ Tests d'IntÃ©gration
    runs-on: ubuntu-latest
    needs: [detect-changes, validate-charts]
    if: ${{ needs.detect-changes.outputs.charts != '' }}  # VÃ©rifie que des changements existent avant de lancer ce job
    
    steps:
    - uses: actions/checkout@v4

    - name: âš™ï¸ Setup Tools
      run: |
        # Helm
        curl https://get.helm.sh/helm-v3.12.0-linux-amd64.tar.gz | tar xz
        sudo mv linux-amd64/helm /usr/local/bin/
        
        # kubectl
        curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/

    - name: ğŸ³ DÃ©marrer Minikube (similaire Ã  votre env)
      uses: medyagh/setup-minikube@master
      with:
        minikube-version: 1.32.0
        kubernetes-version: 1.28.0
        driver: docker
        start-args: '--memory=4096 --cpus=2'

    - name: ğŸ—„ï¸ DÃ©ployer les dÃ©pendances (Base de donnÃ©es)
      if: ${{ needs.detect-changes.outputs.mysql == 'true' || contains(needs.detect-changes.outputs.charts, 'mailserver') || contains(needs.detect-changes.outputs.charts, 'roundcube') }}
      run: |
        echo "ğŸ—„ï¸ DÃ©ploiement MySQL (prÃ©requis)"
        kubectl create namespace database || true
        helm upgrade --install mysql database/mysql/ \
          --namespace database \
          --wait --timeout=300s \
          --set mysql.auth.rootPassword=testpass123
        
        # Attendre que MySQL soit complÃ¨tement prÃªt
        kubectl wait --for=condition=Ready pod -l app.kubernetes.io/name=mysql -n database --timeout=300s
        echo "âœ… MySQL opÃ©rationnel"

    - name: ğŸŒ DÃ©ployer les services DNS (Bind9)
      if: ${{ needs.detect-changes.outputs.bind9 == 'true' }}
      run: |
        echo "ğŸŒ DÃ©ploiement Bind9"
        kubectl create namespace dns || true
        helm upgrade --install bind9 bind9/ \
          --namespace dns \
          --wait --timeout=180s
        echo "âœ… Bind9 dÃ©ployÃ©"

    - name: ğŸŒ DÃ©ployer les services Web
      if: ${{ needs.detect-changes.outputs.web-nginx == 'true' || needs.detect-changes.outputs.web-apache == 'true' }}
      run: |
        kubectl create namespace web || true
        
        if [[ "${{ needs.detect-changes.outputs.web-nginx }}" == "true" ]]; then
          echo "ğŸŒ DÃ©ploiement Nginx"
          helm upgrade --install nginx web-nginx/ \
            --namespace web \
            --wait --timeout=180s
        fi
        
        if [[ "${{ needs.detect-changes.outputs.web-apache }}" == "true" ]]; then
          echo "ğŸŒ DÃ©ploiement Apache"
          helm upgrade --install apache web-apache/ \
            --namespace web \
            --wait --timeout=180s
        fi
        echo "âœ… Services web dÃ©ployÃ©s"

    - name: ğŸ“§ DÃ©ployer les services Mail
      if: ${{ needs.detect-changes.outputs.mailserver == 'true' || needs.detect-changes.outputs.roundcube == 'true' }}
      run: |
        kubectl create namespace mail || true
        
        if [[ "${{ needs.detect-changes.outputs.mailserver }}" == "true" ]]; then
          echo "ğŸ“§ DÃ©ploiement Mailserver"
          helm upgrade --install mailserver mailserver/ \
            --namespace mail \
            --wait --timeout=300s
        fi
        
        if [[ "${{ needs.detect-changes.outputs.roundcube }}" == "true" ]]; then
          echo "ğŸ“§ DÃ©ploiement Roundcube"
          helm upgrade --install roundcube roundcube/ \
            --namespace mail \
            --wait --timeout=180s
        fi
        echo "âœ… Services mail dÃ©ployÃ©s"

    - name: ğŸ“Š DÃ©ployer le Monitoring
      if: ${{ needs.detect-changes.outputs.monitoring == 'true' }}
      run: |
        echo "ğŸ“Š DÃ©ploiement du Monitoring"
        kubectl create namespace monitoring || true
        helm upgrade --install monitoring monitoring/monitoring-chart/ \
          --namespace monitoring \
          --wait --timeout=300s
        echo "âœ… Monitoring dÃ©ployÃ©"

    - name: ğŸ” Tests de ConnectivitÃ© Inter-Services
      run: |
        echo "ğŸ” VÃ©rification de la connectivitÃ©"
        
        # Test MySQL (si prÃ©sent)
        if kubectl get pods -n database -l app.kubernetes.io/name=mysql &>/dev/null; then
          kubectl run mysql-test --rm -i --restart=Never --image=mysql:8.0 -- \
            mysqladmin ping -h mysql.database.svc.cluster.local -u root -ptestpass123 || \
            echo "âš ï¸ MySQL non accessible"
        fi
        
        # Test services web
        for service in nginx apache; do
          if kubectl get svc -n web $service &>/dev/null; then
            kubectl run web-test-$service --rm -i --restart=Never --image=curlimages/curl -- \
              curl -I http://$service.web.svc.cluster.local/ || \
              echo "âš ï¸ $service non accessible"
          fi
        done
        
        echo "âœ… Tests de connectivitÃ© terminÃ©s"

    - name: ğŸ“‹ RÃ©sumÃ© du dÃ©ploiement
      run: |
        echo "ğŸ“‹ === RÃ‰SUMÃ‰ DU DÃ‰PLOIEMENT ==="
        echo "Namespaces crÃ©Ã©s:"
        kubectl get namespaces | grep -E "(database|web|mail|monitoring|dns)" || true
        echo ""
        echo "Services dÃ©ployÃ©s:"
        kubectl get pods --all-namespaces | grep -v "kube-system\|default" || true
        echo ""
        echo "Services rÃ©seau:"
        kubectl get svc --all-namespaces | grep -v "kube-system\|default" || true

  # Job 4: Tests de SÃ©curitÃ© et Performance
  security-performance-tests:
    name: ğŸ”’ SÃ©curitÃ© & Performance
    runs-on: ubuntu-latest
    needs: [detect-changes, validate-charts]
    if: ${{ needs.detect-changes.outputs.charts != '' }}
    
    steps:
    - uses: actions/checkout@v4

    - name: âš™ï¸ Setup Helm
      uses: azure/setup-helm@v3

    - name: ğŸ”’ Audit de SÃ©curitÃ©
      run: |
        echo "ğŸ”’ Audit de sÃ©curitÃ© des configurations"
        
        # VÃ©rification des secrets
        echo "ğŸ” VÃ©rification des secrets..."
        for chart in bind9 database/mysql database/phpmyadmin mailserver monitoring/monitoring-chart roundcube web-apache web-nginx; do
          if [ -d "$chart" ]; then
            # Recherche de mots de passe en dur
            if grep -r "password.*:" "$chart/" --include="*.yaml" | grep -v "passwordSecretRef" | grep -v "# Example" | grep -v "description"; then
              echo "âš ï¸ $chart: Mots de passe potentiellement en dur"
            else
              echo "âœ… $chart: Secrets correctement gÃ©rÃ©s"
            fi
          fi
        done
        
        # VÃ©rification des ressources
        echo "ğŸ” VÃ©rification des limites de ressources..."
        for chart in bind9 database/mysql database/phpmyadmin mailserver monitoring/monitoring-chart roundcube web-apache web-nginx; do
          if [ -d "$chart" ]; then
            if helm template test "$chart/" | grep -q "resources:"; then
              echo "âœ… $chart: Limites de ressources dÃ©finies"
            else
              echo "âš ï¸ $chart: Limites de ressources recommandÃ©es"
            fi
          fi
        done

    - name: ğŸ›¡ï¸ Scan des vulnÃ©rabilitÃ©s
      run: |
        echo "ğŸ›¡ï¸ Analyse des vulnÃ©rabilitÃ©s des images"
        
        # Extraire les images des templates
        for chart in bind9 database/mysql database/phpmyadmin mailserver monitoring/monitoring-chart roundcube web-apache web-nginx; do
          if [ -d "$chart" ]; then
            echo "ğŸ” Images dans $chart:"
            helm template test "$chart/" | grep "image:" | sort | uniq || true
          fi
        done

  # Job 5: Notification et Documentation
  notification:
    name: ğŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [integration-tests, security-performance-tests]
    if: always()
    
    steps:
    - name: ğŸ“Š PrÃ©parer le rapport
      run: |
        echo "ğŸ“Š === RAPPORT DE DÃ‰PLOIEMENT ===" > deployment_report.md
        echo "Date: $(date)" >> deployment_report.md
        echo "Branch: ${{ github.ref }}" >> deployment_report.md
        echo "Commit: ${{ github.sha }}" >> deployment_report.md
        echo "" >> deployment_report.md
        
        if [[ "${{ needs.integration-tests.result }}" == "success" ]]; then
          echo "âœ… Tests d'intÃ©gration: SUCCÃˆS" >> deployment_report.md
        else
          echo "âŒ Tests d'intÃ©gration: Ã‰CHEC" >> deployment_report.md
        fi
        
        if [[ "${{ needs.security-performance-tests.result }}" == "success" ]]; then
          echo "âœ… Tests de sÃ©curitÃ©: SUCCÃˆS" >> deployment_report.md
        else
          echo "âŒ Tests de sÃ©curitÃ©: Ã‰CHEC" >> deployment_report.md
        fi
        
        echo "" >> deployment_report.md
        echo "ğŸš€ DÃ©ploiement prÃªt pour la production!" >> deployment_report.md
        
        cat deployment_report.md

    - name: ğŸ“¢ RÃ©sultat final
      run: |
        if [[ "${{ needs.integration-tests.result }}" == "success" && "${{ needs.security-performance-tests.result }}" == "success" ]]; then
          echo "ğŸ‰ SUCCÃˆS: Tous les tests sont passÃ©s - PrÃªt pour le dÃ©ploiement en production!"
          echo "ğŸ”„ Les services peuvent Ãªtre mis Ã  jour sans interruption"
        else
          echo "âŒ Ã‰CHEC: Certains tests ont Ã©chouÃ© - RÃ©vision nÃ©cessaire avant dÃ©ploiement"
          exit 1
