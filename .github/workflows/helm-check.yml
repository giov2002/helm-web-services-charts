name: 🔍 Vérification des Charts Helm

# Se déclenche uniquement lorsque des modifications sont effectuées dans un sous-dossier spécifique d'un chart
on:
  push:
    paths:
      - 'web-nginx/**'  # Se déclenche uniquement si quelque chose change dans le dossier web-nginx/
      - 'monitoring/**'  # Se déclenche uniquement si quelque chose change dans le dossier monitoring/
      - 'web-apache/**'  # Se déclenche uniquement si quelque chose change dans le dossier web-apache/
      - 'bind9/**'  # Se déclenche uniquement si quelque chose change dans le dossier bind9/
      - 'database/**'  # Se déclenche uniquement si quelque chose change dans le dossier database/
      - 'mailserver/**'  # Se déclenche uniquement si quelque chose change dans le dossier mailserver/
      - 'roundcube/**'  # Se déclenche uniquement si quelque chose change dans le dossier roundcube/

  pull_request:
    paths:
      - 'web-nginx/**'
      - 'monitoring/**'
      - 'web-apache/**'
      - 'bind9/**'
      - 'database/**'
      - 'mailserver/**'
      - 'roundcube/**'

jobs:
  check-helm-charts:
    name: Vérification des Charts Helm
    runs-on: ubuntu-latest  # Machine virtuelle Ubuntu gratuite
    
    steps:
    # 1️⃣ Récupérer le code depuis GitHub
    - name: 📥 Récupérer le code
      uses: actions/checkout@v4

    # 2️⃣ Installer Helm sur la machine virtuelle
    - name: ⚙️ Installer Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'

    # 3️⃣ Vérifier le chart web-nginx
    - name: 🔍 Vérifier le chart web-nginx
      run: |
        echo "=== Vérification du chart web-nginx ==="
        echo "📁 Fichiers dans le chart :"
        ls -la web-nginx/
        
        echo "🔍 Lint du chart (recherche d'erreurs) :"
        helm lint web-nginx/
        
        echo "🧪 Test de génération des templates :"
        helm template test-nginx web-nginx/ --dry-run

    # 4️⃣ Vérifier le chart monitoring
    - name: 🔍 Vérifier le chart monitoring
      run: |
        echo "=== Vérification du chart monitoring ==="
        echo "📁 Fichiers dans le chart :"
        ls -la monitoring/monitoring-chart/
        
        echo "🔍 Lint du chart (recherche d'erreurs) :"
        helm lint monitoring/monitoring-chart/
        
        echo "🧪 Test de génération des templates :"
        helm template test-monitoring monitoring/monitoring-chart/ --dry-run

    # 5️⃣ Résumé final
    - name: ✅ Résumé
      run: |
        echo "🎉 Tous les checks sont passés !"
        echo "Vos charts Helm sont valides et prêts à être déployés."
