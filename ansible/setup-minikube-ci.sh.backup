#!/bin/bash

# Script d'installation et configuration CI pour projet Minikube + Helm
# Adapté pour Debian 12 avec Ansible, Docker, Kubernetes, Helm

set -e

# Configuration
PROJECT_NAME="helm-web-services-charts"
CHARTS_PATH="."

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

print_header() {
    echo -e "${PURPLE}========================================${NC}"
    echo -e "${PURPLE}🚀 SETUP CI MINIKUBE + HELM PROJECT${NC}"
    echo -e "${PURPLE}========================================${NC}"
    echo ""
}

print_step() {
    echo -e "${BLUE}📋 $1${NC}"
}

print_success() {
    echo -e "${GREEN}✅ $1${NC}"
}

print_error() {
    echo -e "${RED}❌ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠️ $1${NC}"
}

print_info() {
    echo -e "${BLUE}ℹ️ $1${NC}"
}

check_prerequisites() {
    print_step "Vérification des prérequis..."
    
    # OS Check
    if [[ ! -f /etc/debian_version ]]; then
        print_warning "Ce script est optimisé pour Debian 12"
    else
        print_success "OS: Debian $(cat /etc/debian_version)"
    fi
    
    # Outils requis
    local tools=("docker" "minikube" "kubectl" "helm" "ansible" "git" "curl" "jq")
    local missing=()
    
    for tool in "${tools[@]}"; do
        if command -v "$tool" &> /dev/null; then
            print_success "$tool trouvé: $(command -v "$tool")"
        else
            missing+=("$tool")
            print_error "$tool non trouvé"
        fi
    done
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        print_error "Outils manquants: ${missing[*]}"
        print_info "Installez-les avec:"
        echo "sudo apt update && sudo apt install -y ${missing[*]}"
        return 1
    fi
}

check_project_structure() {
    print_step "Vérification de la structure du projet..."
    
    # Vérifier qu'on est dans le bon répertoire avec les charts à la racine
    local expected_charts=("bind9" "database" "email" "monitoring" "unbound" "web-apache" "web-nginx")
    local missing_charts=()
    
    for chart in "${expected_charts[@]}"; do
        if [[ ! -d "$chart" ]]; then
            missing_charts+=("$chart")
        fi
    done
    
    if [[ ${#missing_charts[@]} -gt 0 ]]; then
        print_error "Charts manquants: ${missing_charts[*]}"
        print_info "Assurez-vous d'être dans le répertoire racine du projet helm-web-services-charts"
        return 1
    fi
    
    print_success "Structure de charts trouvée à la racine"
    
    # Lister les charts disponibles avec validation Chart.yaml
    echo ""
    print_info "Charts Helm détectés:"
    
    declare -A chart_paths=(
        ["bind9"]="bind9"
        ["mysql"]="database/mysql"
        ["phpmyadmin"]="database/phpmyadmin"
        ["email"]="email"
        ["monitoring"]="monitoring/monitoring-chart"
        ["unbound"]="unbound"
        ["web-apache"]="web-apache"
        ["web-nginx"]="web-nginx"
    )
    
    for chart_name in "${!chart_paths[@]}"; do
        chart_path="${chart_paths[$chart_name]}"
        if [[ -f "$chart_path/Chart.yaml" ]]; then
            print_success "$chart_name ($chart_path)"
        else
            print_error "$chart_name - Chart.yaml manquant dans $chart_path"
        fi
    done
}

check_minikube_status() {
    print_step "Vérification de l'environnement Minikube..."
    
    if minikube status &> /dev/null; then
        print_success "Minikube est actif"
        print_info "Profil: $(minikube profile)"
        if command -v kubectl &> /dev/null; then
            local k8s_version=$(kubectl version --client --short 2>/dev/null | grep "Client Version" | cut -d' ' -f3 || echo "unknown")
            print_info "Version kubectl: $k8s_version"
        fi
    else
        print_warning "Minikube n'est pas actif"
        echo ""
        read -p "🚀 Démarrer Minikube maintenant ? [y/N]: " -n 1 -r
        echo ""
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            print_info "Démarrage de Minikube..."
            minikube start --driver=docker --memory=4096 --cpus=2
            print_success "Minikube démarré!"
        else
            print_info "Minikube restera inactif (vous pourrez le démarrer plus tard)"
        fi
    fi
}

setup_github_config() {
    print_step "Configuration GitHub..."
    
    # Auto-détection du repo Git
    if [[ -d ".git" ]]; then
        REMOTE_URL=$(git remote get-url origin 2>/dev/null || echo "")
        if [[ "$REMOTE_URL" =~ github\.com[:/]([^/]+)/([^/.]+) ]]; then
            AUTO_OWNER="${BASH_REMATCH[1]}"
            AUTO_REPO="${BASH_REMATCH[2]}"
            print_success "Repo détecté automatiquement: $AUTO_OWNER/$AUTO_REPO"
            
            # Mise à jour du fichier de config
            if [[ -f "ansible/ansible-minikube-config.yml" ]]; then
                sed -i "s/VOTRE_USERNAME/$AUTO_OWNER/g" ansible/ansible-minikube-config.yml 2>/dev/null || true
                sed -i "s/ansible-lab/$AUTO_REPO/g" ansible/ansible-minikube-config.yml 2>/dev/null || true
                print_success "Configuration mise à jour automatiquement"
            fi
            
        else
            print_warning "Impossible de détecter le repo GitHub depuis l'URL Git"
        fi
    else
        print_warning "Pas de repo Git détecté"
    fi
    
    # Configuration du token
    if [[ -z "$GITHUB_PAT" ]]; then
        print_warning "Variable GITHUB_PAT non définie"
        print_info "Pour configurer le token GitHub:"
        echo "  1. Allez sur https://github.com/settings/tokens"
        echo "  2. Créez un token avec scopes: repo, workflow"
        echo "  3. Exportez-le: export GITHUB_PAT='your_token_here'"
        echo ""
        read -p "📋 Avez-vous déjà un token GitHub ? [y/N]: " -n 1 -r
        echo ""
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            read -p "🔑 Collez votre token (masqué): " -s github_token
            echo ""
            export GITHUB_PAT="$github_token"
            print_success "Token configuré pour cette session"
        fi
    else
        print_success "Token GitHub détecté"
    fi
}

create_workflow_files() {
    print_step "Création des fichiers workflow..."
    
    # Créer le répertoire .github/workflows s'il n'existe pas
    mkdir -p .github/workflows
    
    # Vérifier si les workflows existent déjà
    if [[ -f ".github/workflows/helm-full-check.yml" ]]; then
        print_success "Workflow CI déjà présent"
    else
        print_warning "Workflow CI manquant"
        print_info "Copiez le contenu du workflow helm-full-check.yml dans .github/workflows/"
    fi
    
    # Vérifier si le workflow helm-check.yml existe aussi
    if [[ -f ".github/workflows/helm-check.yml" ]]; then
        print_info "Workflow helm-check.yml également présent"
    fi
}

test_ci_trigger() {
    print_step "Test du déclenchement CI..."
    
    if [[ -z "$GITHUB_PAT" ]]; then
        print_warning "Impossible de tester sans token GitHub"
        return 0
    fi
    
    print_info "Test en mode dry-run..."
    
    # Test avec le playbook Ansible
    if [[ -f "ansible/minikube-ci-trigger.yml" ]]; then
        if ansible-playbook ansible/minikube-ci-trigger.yml --check -v > /dev/null 2>&1; then
            print_success "Playbook Ansible validé"
        else
            print_warning "Playbook nécessite des ajustements (normal en dry-run)"
        fi
    else
        print_warning "Playbook minikube-ci-trigger.yml non trouvé"
    fi
}

show_next_steps() {
    print_step "Prochaines étapes..."
    
    echo ""
    print_info "🎯 Pour déclencher le CI:"
    echo "  # Méthode recommandée: Playbook Ansible"
    echo "  ansible-playbook ansible/minikube-ci-trigger.yml -e check_type=full"
    echo ""
    echo "  # Autres options de vérification:"
    echo "  ansible-playbook ansible/minikube-ci-trigger.yml -e check_type=security-only"
    echo "  ansible-playbook ansible/minikube-ci-trigger.yml -e check_type=lint-only"
    echo ""
    
    print_info "🔍 Types de vérification disponibles:"
    echo "  - full          : Validation complète (recommandé)"
    echo "  - security-only : Audit sécurité uniquement" 
    echo "  - lint-only     : Lint YAML uniquement"
    echo ""
    
    print_info "📦 Charts qui seront validés:"
    echo "  - bind9 (DNS)"
    echo "  - mysql + phpmyadmin (Database)"
    echo "  - email (Mail server)"
    echo "  - monitoring (Prometheus + Grafana)"
    echo "  - unbound (DNS resolver)"
    echo "  - web-apache + web-nginx (Web servers)"
    echo ""
    
    print_info "📋 Workflow du projet:"
    echo "  1. 🔍 CI validation (GitHub Actions) ← Vous êtes ici"
    echo "  2. ✅ Si OK → Prêt pour déploiement manuel"
    echo "  3. 🚀 Déploiement sur Minikube (manuel pour l'instant)"
    echo "  4. 📊 Monitoring des services"
    echo ""
    
    if [[ -n "$AUTO_OWNER" && -n "$AUTO_REPO" ]]; then
        print_info "🌐 Liens utiles:"
        echo "  - Actions GitHub: https://github.com/$AUTO_OWNER/$AUTO_REPO/actions"
        echo "  - Dashboard Minikube: minikube dashboard"
        echo "  - Logs Kubectl: kubectl logs -f deployment/{service}"
    fi
}

# Execution principale
main() {
    print_header
    
    print_info "🎯 Setup pour projet: Ansible + Docker + Kubernetes + Helm + CI"
    print_info "🏗️ Environnement cible: Debian 12 + Minikube"
    print_info "📦 Charts détectés: 8 services (DNS, DB, Web, Email, Monitoring)"
    echo ""
    
    check_prerequisites || exit 1
    echo ""
    
    check_project_structure || exit 1
    echo ""
    
    check_minikube_status
    echo ""
    
    setup_github_config
    echo ""
    
    create_workflow_files
    echo ""
    
    test_ci_trigger
    echo ""
    
    show_next_steps
    
    echo ""
    print_success "🎉 Setup terminé!"
    print_info "Vous pouvez maintenant déclencher votre CI Helm Charts!"
    echo ""
    print_info "Commande rapide:"
    echo "export GITHUB_PAT='your_token' && ansible-playbook ansible/minikube-ci-trigger.yml -e check_type=full"
}

# Point d'entrée
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
