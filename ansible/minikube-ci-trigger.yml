---
# Playbook Ansible pour dÃ©clencher CI Helm dans un environnement Minikube
# AdaptÃ© pour projet : Ansible + Docker + Kubernetes + Helm + CI/CD

- name: ğŸš€ DÃ©clencheur CI Helm - Projet Minikube
  hosts: localhost
  gather_facts: yes
  vars_files:
    - ansible-minikube-config.yml
  
  vars:
    # Valeurs par dÃ©faut (overridables)
    check_type: "{{ check_type | default('full') }}"
    github_owner: "{{ github.owner }}"
    github_repo: "{{ github.repo }}"
    github_token: "{{ github_pat | default(ansible_env.GITHUB_PAT) }}"
    
  pre_tasks:
    - name: ğŸ“‹ VÃ©rification de l'environnement Minikube
      block:
        - name: ğŸ” VÃ©rifier Minikube
          command: minikube status
          register: minikube_status
          failed_when: false
          changed_when: false
          
        - name: ğŸ“Š Statut Minikube
          debug:
            msg: |
              ğŸ¯ Environnement dÃ©tectÃ©:
              - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
              - Minikube: {{ 'Actif' if minikube_status.rc == 0 else 'Inactif' }}
              - Architecture: {{ ansible_architecture }}
              
        - name: âš ï¸ Avertissement Minikube inactif
          debug:
            msg: |
              âš ï¸ Minikube semble inactif. 
              Le CI va valider les charts mais le dÃ©ploiement nÃ©cessitera Minikube actif.
          when: minikube_status.rc != 0

  tasks:
    - name: ğŸ“¦ Inventaire des charts Helm disponibles
      find:
        paths: "{{ paths.helm_charts }}"
        file_type: directory
        recurse: no
      register: charts_dirs
      
    - name: ğŸ” Validation de la structure des charts
      block:
        - name: ğŸ“‹ Lister les charts dÃ©tectÃ©s
          debug:
            msg: |
              ğŸ“¦ Charts Helm dÃ©tectÃ©s:
              {% for chart_dir in charts_dirs.files %}
              - {{ chart_dir.path | basename }}
              {% endfor %}
              
        - name: âœ… VÃ©rifier Chart.yaml pour chaque chart
          stat:
            path: "{{ item.path }}/Chart.yaml"
          register: chart_files
          loop: "{{ charts_dirs.files }}"
          
        - name: ğŸ“Š RÃ©sumÃ© de validation
          debug:
            msg: |
              ğŸ“Š Validation des charts:
              {% for result in chart_files.results %}
              - {{ result.item.path | basename }}: {{ 'âœ… Valide' if result.stat.exists else 'âŒ Chart.yaml manquant' }}
              {% endfor %}

    - name: ğŸ” VÃ©rification des prÃ©requis CI
      block:
        - name: ğŸ”‘ VÃ©rifier le token GitHub
          fail:
            msg: |
              âŒ Token GitHub manquant!
              
              Solutions:
              1. Variable d'environnement: export GITHUB_PAT="your_token"
              2. ParamÃ¨tre Ansible: -e github_pat="your_token"
              3. Vault Ansible (recommandÃ©)
              
              CrÃ©er un token: https://github.com/settings/tokens
              Scopes requis: repo, workflow
          when: github_token is not defined or github_token == ""
          
        - name: ğŸ“¡ Test de connectivitÃ© GitHub
          uri:
            url: "https://api.github.com/repos/{{ github_owner }}/{{ github_repo }}"
            headers:
              Authorization: "token {{ github_token }}"
              Accept: "application/vnd.github.v3+json"
            method: GET
          register: github_test
          
        - name: âœ… Connexion GitHub OK
          debug:
            msg: |
              âœ… Connexion GitHub Ã©tablie:
              - Repo: {{ github_test.json.full_name }}
              - VisibilitÃ©: {{ github_test.json.visibility }}
              - DerniÃ¨re MAJ: {{ github_test.json.updated_at }}

    - name: ğŸš€ DÃ©clenchement du CI GitHub Actions
      block:
        - name: ğŸ“ ParamÃ¨tres du dÃ©clenchement
          debug:
            msg: |
              ğŸ¯ DÃ©clenchement CI avec les paramÃ¨tres:
              - Type de check: {{ check_type }}
              - Workflow: {{ ci_cd.ci.workflow }}
              - DÃ©clenchÃ© par: Ansible (Minikube)
              - Charts Ã  valider: {{ services.keys() | list | join(', ') }}
              
        - name: ğŸš€ Lancement du workflow
          uri:
            url: "https://api.github.com/repos/{{ github_owner }}/{{ github_repo }}/actions/workflows/{{ ci_cd.ci.workflow }}/dispatches"
            method: POST
            headers:
              Authorization: "token {{ github_token }}"
              Accept: "application/vnd.github.v3+json"
              Content-Type: "application/json"
            body_format: json
            body:
              ref: "{{ github.branch }}"
              inputs:
                check_type: "{{ check_type }}"
            status_code: 204
          register: workflow_dispatch
          
        - name: âœ… CI dÃ©clenchÃ© avec succÃ¨s
          debug:
            msg: |
              ğŸ‰ CI Helm Charts dÃ©clenchÃ© avec succÃ¨s!
              
              ğŸ“‹ Prochaines Ã©tapes:
              1. ğŸŒ Suivez l'exÃ©cution: https://github.com/{{ github_owner }}/{{ github_repo }}/actions
              2. â³ Attendez la validation (5-10 minutes)
              3. âœ… Si CI vert â†’ PrÃªt pour le dÃ©ploiement Minikube
              4. âŒ Si CI rouge â†’ VÃ©rifiez les logs et corrigez
              
              ğŸ”„ Pour relancer: ansible-playbook {{ ansible_play_name }} -e check_type={{ check_type }}

  post_tasks:
    - name: ğŸ“Š Rapport final
      debug:
        msg: |
          ğŸ“Š === RAPPORT CI MINIKUBE ===
          
          ğŸ—ï¸ Environnement:
          - Plateforme: {{ project_environment.platform }}
          - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          - Kubernetes: Minikube {{ '(actif)' if minikube_status.rc == 0 else '(inactif)' }}
          
          ğŸ“¦ Charts validÃ©s:
          {% for service in services.keys() %}
          - {{ service }} (prioritÃ© {{ services[service].priority }})
          {% endfor %}
          
          ğŸ¯ Actions rÃ©alisÃ©es:
          - âœ… Validation de l'environnement local
          - âœ… VÃ©rification des charts Helm
          - âœ… Test connectivitÃ© GitHub
          - âœ… DÃ©clenchement CI GitHub Actions
          
          ğŸš€ Le processus de validation est en cours sur GitHub Actions!
          
    - name: ğŸ’¡ Conseils pour la suite
      debug:
        msg: |
          ğŸ’¡ === CONSEILS POUR LA SUITE ===
          
          ğŸ”„ Pendant que le CI tourne:
          - PrÃ©parez votre environnement Minikube si inactif
          - VÃ©rifiez vos namespaces Kubernetes
          - Assurez-vous que Docker daemon est actif
          
          ğŸ“ AprÃ¨s validation CI:
          - Si âœ…: On crÃ©era le workflow CD pour dÃ©ployer sur Minikube
          - Si âŒ: On corrigera les charts et relancera
          
          ğŸ¯ Commandes utiles:
          - minikube start (si besoin)
          - kubectl get namespaces
          - docker ps
          - helm list -A
