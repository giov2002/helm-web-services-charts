---
- name: Trigger GitHub Actions CI
  hosts: localhost
  gather_facts: no
  vars:
    github_owner: "giov2002"
    github_repo: "helm-web-services-charts"
    github_branch: "main"
    workflow_file: "helm-full-check.yml"
    github_token: "{{ lookup('env', 'GITHUB_PAT') }}"
    
  tasks:
    - name: Verify GitHub token
      fail:
        msg: "GitHub token required. Set: export GITHUB_PAT='your_token'"
      when: github_token == ""
      
    - name: Test GitHub connectivity
      uri:
        url: "https://api.github.com/repos/{{ github_owner }}/{{ github_repo }}"
        headers:
          Authorization: "token {{ github_token }}"
        method: GET
      register: github_test
      
    - name: Trigger GitHub Actions workflow
      uri:
        url: "https://api.github.com/repos/{{ github_owner }}/{{ github_repo }}/actions/workflows/{{ workflow_file }}/dispatches"
        method: POST
        headers:
          Authorization: "token {{ github_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          ref: "{{ github_branch }}"
          inputs:
            check_type: "full"
        status_code: 204
        
    - name: Success
      debug:
        msg: "CI triggered! Check: https://github.com/{{ github_owner }}/{{ github_repo }}/actions"