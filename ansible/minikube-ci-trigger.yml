---
- name: ğŸš€ DÃ©clencheur CI Helm - Projet Minikube
  hosts: localhost
  gather_facts: yes
  vars_files:
    - ansible-minikube-config.yml
  
  vars:
    check_type: "{{ check_type | default('full') }}"
    github_owner: "{{ github.owner }}"
    github_repo: "{{ github.repo }}"
    github_token: "{{ github_pat | default(ansible_env.GITHUB_PAT) }}"
    
    # Charts selon votre structure
    chart_list:
      - bind9
      - mysql
      - phpmyadmin
      - email
      - monitoring
      - unbound
      - web-apache
      - web-nginx
    
  pre_tasks:
    - name: ğŸ“‹ VÃ©rification de l'environnement
      debug:
        msg: |
          ğŸ¯ Environnement CI:
          - OS: {{ ansible_distribution }}
          - Check type: {{ check_type }}
          - Charts: {{ chart_list | length }} dÃ©tectÃ©s

    - name: ğŸ” VÃ©rifier Minikube
      command: minikube status
      register: minikube_status
      failed_when: false
      changed_when: false

    - name: ğŸ“Š Statut environnement
      debug:
        msg: |
          ğŸ“Š Status:
          - Minikube: {{ 'Actif' if minikube_status.rc == 0 else 'Inactif' }}
          - GitHub Repo: {{ github_owner }}/{{ github_repo }}

  tasks:
    - name: ğŸ“¦ VÃ©rification rapide des charts
      stat:
        path: "{{ item }}/Chart.yaml"
      register: charts_check
      loop:
        - ./bind9
        - ./database/mysql
        - ./database/phpmyadmin
        - ./email
        - ./monitoring/monitoring-chart
        - ./unbound
        - ./web-apache
        - ./web-nginx

    - name: ğŸ“Š RÃ©sumÃ© validation charts
      debug:
        msg: |
          ğŸ“Š Charts validation:
          - Valides: {{ charts_check.results | selectattr('stat.exists') | list | length }}
          - Total: {{ charts_check.results | length }}

    - name: ğŸ” VÃ©rification GitHub token
      fail:
        msg: |
          âŒ Token GitHub requis!
          Export: export GITHUB_PAT="your_token"
          Ou: -e github_pat="your_token"
      when: github_token is not defined or github_token == ""

    - name: ğŸ“¡ Test connectivitÃ© GitHub
      uri:
        url: "https://api.github.com/repos/{{ github_owner }}/{{ github_repo }}"
        headers:
          Authorization: "token {{ github_token }}"
          Accept: "application/vnd.github.v3+json"
        method: GET
      register: github_test

    - name: ğŸš€ DÃ©clenchement CI GitHub Actions
      uri:
        url: "https://api.github.com/repos/{{ github_owner }}/{{ github_repo }}/actions/workflows/{{ ci_cd.ci.workflow }}/dispatches"
        method: POST
        headers:
          Authorization: "token {{ github_token }}"
          Accept: "application/vnd.github.v3+json"
          Content-Type: "application/json"
        body_format: json
        body:
          ref: "{{ github.branch }}"
          inputs:
            check_type: "{{ check_type }}"
        status_code: 204
      register: workflow_dispatch

    - name: âœ… CI dÃ©clenchÃ©
      debug:
        msg: |
          ğŸ‰ CI GitHub Actions dÃ©clenchÃ©!
          
          ğŸŒ Suivi: https://github.com/{{ github_owner }}/{{ github_repo }}/actions
          â³ Temps estimÃ©: 5-10 minutes
          
          ğŸ“ Prochaines Ã©tapes:
          1. Attendre validation CI
          2. Si OK â†’ ansible-playbook ansible/minikube-cd-deploy.yml
          3. Si KO â†’ Corriger et relancer