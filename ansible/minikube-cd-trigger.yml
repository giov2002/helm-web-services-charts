---
# Playbook Ansible pour dÃ©clencher CD Helm dans un environnement Minikube

- name: ğŸš€ DÃ©clencheur CD Helm - DÃ©ploiement Minikube
  hosts: localhost
  gather_facts: yes
  vars_files:
    - ansible-minikube-config.yml
  
  vars:
    # ParamÃ¨tres par dÃ©faut (overridables)
    _deployment_type: "{{ deployment_type | default('single-service') }}"
    _target_service: "{{ target_service | default('bind9') }}"
    _environment: "{{ environment | default('dev') }}"
    _force_recreate: "{{ force_recreate | default(false) }}"
    github_owner: "{{ github.owner }}"
    github_repo: "{{ github.repo }}"
    github_token: "{{ github_pat | default(ansible_env.GITHUB_PAT) }}"
    
  pre_tasks:
    - name: ğŸ“‹ VÃ©rification de l'environnement de dÃ©ploiement
      block:
        - name: ğŸ” VÃ©rifier Minikube
          command: minikube status
          register: minikube_status
          failed_when: false
          changed_when: false
          
        - name: âŒ Ã‰chec si Minikube inactif
          fail:
            msg: |
              âŒ Minikube n'est pas actif!
              
              Le dÃ©ploiement nÃ©cessite Minikube en cours d'exÃ©cution.
              
              Solutions:
              1. DÃ©marrer Minikube: minikube start --driver=docker --memory=4096 --cpus=2
              2. VÃ©rifier le statut: minikube status
              3. Relancer le dÃ©ploiement
          when: minikube_status.rc != 0
          
        - name: ğŸ“Š Statut environnement
          debug:
            msg: |
              ğŸ¯ Environnement de dÃ©ploiement:
              - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
              - Minikube: Actif
              - Architecture: {{ ansible_architecture }}
              - Type de dÃ©ploiement: {{ _deployment_type }}
              - Service cible: {{ _target_service }}
              - Environnement: {{ _environment }}

  tasks:
    - name: ğŸ” Validation des prÃ©requis CD
      block:
        - name: ğŸ”‘ VÃ©rifier le token GitHub
          fail:
            msg: |
              âŒ Token GitHub manquant pour le dÃ©ploiement!
              
              Le CD nÃ©cessite l'accÃ¨s Ã  GitHub Actions.
              
              Solutions:
              1. Variable d'environnement: export GITHUB_PAT="your_token"
              2. ParamÃ¨tre Ansible: -e github_pat="your_token"
              
              Token requis avec scopes: repo, workflow
          when: github_token is not defined or github_token == ""
          
        - name: ğŸ“¡ Test de connectivitÃ© GitHub
          uri:
            url: "https://api.github.com/repos/{{ github_owner }}/{{ github_repo }}"
            headers:
              Authorization: "token {{ github_token }}"
              Accept: "application/vnd.github.v3+json"
            method: GET
          register: github_test

    - name: ğŸ“¦ Validation du service cible
      block:
        - name: âœ… VÃ©rifier que le service existe
          fail:
            msg: |
              âŒ Service '{{ _target_service }}' non reconnu!
              
              Services disponibles:
              {% for service in services.keys() %}
              - {{ service }} ({{ services[service].path }})
              {% endfor %}
          when: 
            - _deployment_type == "single-service"
            - _target_service not in services.keys()
            
        - name: ğŸ“‹ Informations du service
          debug:
            msg: |
              ğŸ“¦ Service Ã  dÃ©ployer:
              - Nom: {{ _target_service }}
              - Path: {{ services[_target_service].path }}
              - Namespace: {{ services[_target_service].namespace }}
              - PrioritÃ©: {{ services[_target_service].priority }}
              {% if services[_target_service].dependencies %}
              - DÃ©pendances: {{ services[_target_service].dependencies | join(', ') }}
              {% endif %}
          when: _deployment_type == "single-service"

    - name: ğŸš€ DÃ©ploiement automatique Helm
      block:
        - name: ğŸ“ ParamÃ¨tres de dÃ©ploiement
          debug:
            msg: |
              ğŸ¯ DÃ©ploiement automatique avec les paramÃ¨tres:
              - Type: {{ _deployment_type }}
              - Service: {{ _target_service }}
              - Environnement: {{ _environment }}
              - Force recreate: {{ _force_recreate }}
              
        - name: ğŸ—‚ï¸ Changement vers le rÃ©pertoire du service
          shell: pwd
          register: current_dir
          changed_when: false
          
        - name: ğŸš€ Installation Helm du service
          shell: |
            cd {{ services[_target_service].path }}
            helm upgrade --install {{ _target_service }} . \
              -n {{ services[_target_service].namespace }} \
              --create-namespace \
              {{ '--force' if _force_recreate else '' }}
          register: helm_deploy
          when: _deployment_type == "single-service"
          
        - name: ğŸš€ Installation Helm de tous les services
          shell: |
            cd {{ item.value.path }}
            helm upgrade --install {{ item.key }} . \
              -n {{ item.value.namespace }} \
              --create-namespace \
              {{ '--force' if _force_recreate else '' }}
          loop: "{{ services | dict2items }}"
          register: helm_deploy_all
          when: _deployment_type == "full-stack"
          
        - name: âœ… DÃ©ploiement terminÃ©
          debug:
            msg: |
              ğŸ‰ DÃ©ploiement Helm terminÃ© avec succÃ¨s!
              
              ğŸ“‹ VÃ©rifications:
              - kubectl get pods -n {{ services[_target_service].namespace }}
              - kubectl get svc -n {{ services[_target_service].namespace }}
              - helm status {{ _target_service }} -n {{ services[_target_service].namespace }}
          when: _deployment_type == "single-service"
          
        - name: âœ… DÃ©ploiement complet terminÃ©
          debug:
            msg: |
              ğŸ‰ DÃ©ploiement complet terminÃ©!
              
              ğŸ“‹ VÃ©rifications:
              - kubectl get pods -A
              - kubectl get svc -A
              - helm list -A
          when: _deployment_type == "full-stack"

  post_tasks:
    - name: ğŸ“Š Rapport de lancement CD
      debug:
        msg: |
          ğŸ“Š === RAPPORT LANCEMENT CD ===
          
          ğŸ—ï¸ Environnement:
          - Plateforme: {{ project_environment.platform }}
          - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          - Kubernetes: Minikube (actif)
          
          ğŸ¯ DÃ©ploiement configurÃ©:
          - Type: {{ _deployment_type }}
          {% if _deployment_type == "single-service" %}
          - Service: {{ _target_service }}
          {% else %}
          - Services: Tous les services configurÃ©s
          {% endif %}
          - Environnement: {{ _environment }}
          
          ğŸš€ Actions rÃ©alisÃ©es:
          - âœ… Validation environnement Minikube
          - âœ… Test connectivitÃ© GitHub
          - âœ… Validation du service cible
          - âœ… DÃ©clenchement workflow CD
          
          ğŸ“± Le dÃ©ploiement automatique est terminÃ©!
          
    - name: ğŸ’¡ Commandes utiles post-dÃ©ploiement
      debug:
        msg: |
          ğŸ’¡ === COMMANDES UTILES ===
          
          ğŸ“Š Surveillance du dÃ©ploiement:
          - minikube dashboard
          - kubectl get pods -A
          - kubectl get svc -A
          - helm list -A
          
          ğŸ” Debug en cas de problÃ¨me:
          - kubectl describe pod POD_NAME -n NAMESPACE
          - kubectl logs POD_NAME -n NAMESPACE
          - helm status RELEASE_NAME -n NAMESPACE
          
          ğŸ”„ Gestion des dÃ©ploiements:
          - kubectl port-forward svc/SERVICE_NAME PORT:PORT -n NAMESPACE
          - helm rollback RELEASE_NAME REVISION -n NAMESPACE