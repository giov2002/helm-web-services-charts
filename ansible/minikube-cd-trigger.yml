---
# Playbook Ansible pour déclencher CD Helm dans un environnement Minikube

- name: 🚀 Déclencheur CD Helm - Déploiement Minikube
  hosts: localhost
  gather_facts: yes
  vars_files:
    - ansible-minikube-config.yml
  
  vars:
    # Paramètres par défaut (overridables)
    _deployment_type: "{{ deployment_type | default('single-service') }}"
    _target_service: "{{ target_service | default('bind9') }}"
    _environment: "{{ environment | default('dev') }}"
    _force_recreate: "{{ force_recreate | default(false) }}"
    github_owner: "{{ github.owner }}"
    github_repo: "{{ github.repo }}"
    github_token: "{{ github_pat | default(ansible_env.GITHUB_PAT) }}"
    
  pre_tasks:
    - name: 📋 Vérification de l'environnement de déploiement
      block:
        - name: 🔍 Vérifier Minikube
          command: minikube status
          register: minikube_status
          failed_when: false
          changed_when: false
          
        - name: ❌ Échec si Minikube inactif
          fail:
            msg: |
              ❌ Minikube n'est pas actif!
              
              Le déploiement nécessite Minikube en cours d'exécution.
              
              Solutions:
              1. Démarrer Minikube: minikube start --driver=docker --memory=4096 --cpus=2
              2. Vérifier le statut: minikube status
              3. Relancer le déploiement
          when: minikube_status.rc != 0
          
        - name: 📊 Statut environnement
          debug:
            msg: |
              🎯 Environnement de déploiement:
              - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
              - Minikube: Actif
              - Architecture: {{ ansible_architecture }}
              - Type de déploiement: {{ _deployment_type }}
              - Service cible: {{ _target_service }}
              - Environnement: {{ _environment }}

  tasks:
    - name: 🔐 Validation des prérequis CD
      block:
        - name: 🔑 Vérifier le token GitHub
          fail:
            msg: |
              ❌ Token GitHub manquant pour le déploiement!
              
              Le CD nécessite l'accès à GitHub Actions.
              
              Solutions:
              1. Variable d'environnement: export GITHUB_PAT="your_token"
              2. Paramètre Ansible: -e github_pat="your_token"
              
              Token requis avec scopes: repo, workflow
          when: github_token is not defined or github_token == ""
          
        - name: 📡 Test de connectivité GitHub
          uri:
            url: "https://api.github.com/repos/{{ github_owner }}/{{ github_repo }}"
            headers:
              Authorization: "token {{ github_token }}"
              Accept: "application/vnd.github.v3+json"
            method: GET
          register: github_test

    - name: 📦 Validation du service cible
      block:
        - name: ✅ Vérifier que le service existe
          fail:
            msg: |
              ❌ Service '{{ _target_service }}' non reconnu!
              
              Services disponibles:
              {% for service in services.keys() %}
              - {{ service }} ({{ services[service].path }})
              {% endfor %}
          when: 
            - _deployment_type == "single-service"
            - _target_service not in services.keys()
            
        - name: 📋 Informations du service
          debug:
            msg: |
              📦 Service à déployer:
              - Nom: {{ _target_service }}
              - Path: {{ services[_target_service].path }}
              - Namespace: {{ services[_target_service].namespace }}
              - Priorité: {{ services[_target_service].priority }}
              {% if services[_target_service].dependencies %}
              - Dépendances: {{ services[_target_service].dependencies | join(', ') }}
              {% endif %}
          when: _deployment_type == "single-service"

    - name: 🚀 Déploiement automatique Helm
      block:
        - name: 📝 Paramètres de déploiement
          debug:
            msg: |
              🎯 Déploiement automatique avec les paramètres:
              - Type: {{ _deployment_type }}
              - Service: {{ _target_service }}
              - Environnement: {{ _environment }}
              - Force recreate: {{ _force_recreate }}
              
        - name: 🗂️ Changement vers le répertoire du service
          shell: pwd
          register: current_dir
          changed_when: false
          
        - name: 🚀 Installation Helm du service
          shell: |
            cd {{ services[_target_service].path }}
            helm upgrade --install {{ _target_service }} . \
              -n {{ services[_target_service].namespace }} \
              --create-namespace \
              {{ '--force' if _force_recreate else '' }}
          register: helm_deploy
          when: _deployment_type == "single-service"
          
        - name: 🚀 Installation Helm de tous les services
          shell: |
            cd {{ item.value.path }}
            helm upgrade --install {{ item.key }} . \
              -n {{ item.value.namespace }} \
              --create-namespace \
              {{ '--force' if _force_recreate else '' }}
          loop: "{{ services | dict2items }}"
          register: helm_deploy_all
          when: _deployment_type == "full-stack"
          
        - name: ✅ Déploiement terminé
          debug:
            msg: |
              🎉 Déploiement Helm terminé avec succès!
              
              📋 Vérifications:
              - kubectl get pods -n {{ services[_target_service].namespace }}
              - kubectl get svc -n {{ services[_target_service].namespace }}
              - helm status {{ _target_service }} -n {{ services[_target_service].namespace }}
          when: _deployment_type == "single-service"
          
        - name: ✅ Déploiement complet terminé
          debug:
            msg: |
              🎉 Déploiement complet terminé!
              
              📋 Vérifications:
              - kubectl get pods -A
              - kubectl get svc -A
              - helm list -A
          when: _deployment_type == "full-stack"

  post_tasks:
    - name: 📊 Rapport de lancement CD
      debug:
        msg: |
          📊 === RAPPORT LANCEMENT CD ===
          
          🏗️ Environnement:
          - Plateforme: {{ project_environment.platform }}
          - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          - Kubernetes: Minikube (actif)
          
          🎯 Déploiement configuré:
          - Type: {{ _deployment_type }}
          {% if _deployment_type == "single-service" %}
          - Service: {{ _target_service }}
          {% else %}
          - Services: Tous les services configurés
          {% endif %}
          - Environnement: {{ _environment }}
          
          🚀 Actions réalisées:
          - ✅ Validation environnement Minikube
          - ✅ Test connectivité GitHub
          - ✅ Validation du service cible
          - ✅ Déclenchement workflow CD
          
          📱 Le déploiement automatique est terminé!
          
    - name: 💡 Commandes utiles post-déploiement
      debug:
        msg: |
          💡 === COMMANDES UTILES ===
          
          📊 Surveillance du déploiement:
          - minikube dashboard
          - kubectl get pods -A
          - kubectl get svc -A
          - helm list -A
          
          🔍 Debug en cas de problème:
          - kubectl describe pod POD_NAME -n NAMESPACE
          - kubectl logs POD_NAME -n NAMESPACE
          - helm status RELEASE_NAME -n NAMESPACE
          
          🔄 Gestion des déploiements:
          - kubectl port-forward svc/SERVICE_NAME PORT:PORT -n NAMESPACE
          - helm rollback RELEASE_NAME REVISION -n NAMESPACE