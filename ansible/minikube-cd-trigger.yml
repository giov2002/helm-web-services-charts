---
# Playbook Ansible pour dÃ©clencher CD Helm dans un environnement Minikube

- name: ğŸš€ DÃ©clencheur CD Helm - DÃ©ploiement Minikube
  hosts: localhost
  gather_facts: yes
  vars_files:
    - ansible-minikube-config.yml
  
  vars:
    # ParamÃ¨tres par dÃ©faut (overridables)
    deployment_type: "{{ deployment_type | default('single-service') }}"
    target_service: "{{ target_service | default('bind9') }}"
    environment: "{{ environment | default('dev') }}"
    force_recreate: "{{ force_recreate | default(false) }}"
    github_owner: "{{ github.owner }}"
    github_repo: "{{ github.repo }}"
    github_token: "{{ github_pat | default(ansible_env.GITHUB_PAT) }}"
    
  pre_tasks:
    - name: ğŸ“‹ VÃ©rification de l'environnement de dÃ©ploiement
      block:
        - name: ğŸ” VÃ©rifier Minikube
          command: minikube status
          register: minikube_status
          failed_when: false
          changed_when: false
          
        - name: âŒ Ã‰chec si Minikube inactif
          fail:
            msg: |
              âŒ Minikube n'est pas actif!
              
              Le dÃ©ploiement nÃ©cessite Minikube en cours d'exÃ©cution.
              
              Solutions:
              1. DÃ©marrer Minikube: minikube start --driver=docker --memory=4096 --cpus=2
              2. VÃ©rifier le statut: minikube status
              3. Relancer le dÃ©ploiement
          when: minikube_status.rc != 0
          
        - name: ğŸ“Š Statut environnement
          debug:
            msg: |
              ğŸ¯ Environnement de dÃ©ploiement:
              - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
              - Minikube: Actif
              - Architecture: {{ ansible_architecture }}
              - Type de dÃ©ploiement: {{ deployment_type }}
              - Service cible: {{ target_service }}
              - Environnement: {{ environment }}

  tasks:
    - name: ğŸ” Validation des prÃ©requis CD
      block:
        - name: ğŸ”‘ VÃ©rifier le token GitHub
          fail:
            msg: |
              âŒ Token GitHub manquant pour le dÃ©ploiement!
              
              Le CD nÃ©cessite l'accÃ¨s Ã  GitHub Actions.
              
              Solutions:
              1. Variable d'environnement: export GITHUB_PAT="your_token"
              2. ParamÃ¨tre Ansible: -e github_pat="your_token"
              
              Token requis avec scopes: repo, workflow
          when: github_token is not defined or github_token == ""
          
        - name: ğŸ“¡ Test de connectivitÃ© GitHub
          uri:
            url: "https://api.github.com/repos/{{ github_owner }}/{{ github_repo }}"
            headers:
              Authorization: "token {{ github_token }}"
              Accept: "application/vnd.github.v3+json"
            method: GET
          register: github_test

    - name: ğŸ“¦ Validation du service cible
      block:
        - name: âœ… VÃ©rifier que le service existe
          fail:
            msg: |
              âŒ Service '{{ target_service }}' non reconnu!
              
              Services disponibles:
              {% for service in services.keys() %}
              - {{ service }} ({{ services[service].path }})
              {% endfor %}
          when: 
            - deployment_type == "single-service"
            - target_service not in services.keys()
            
        - name: ğŸ“‹ Informations du service
          debug:
            msg: |
              ğŸ“¦ Service Ã  dÃ©ployer:
              - Nom: {{ target_service }}
              - Path: {{ services[target_service].path }}
              - Namespace: {{ services[target_service].namespace }}
              - PrioritÃ©: {{ services[target_service].priority }}
              {% if services[target_service].dependencies %}
              - DÃ©pendances: {{ services[target_service].dependencies | join(', ') }}
              {% endif %}
          when: deployment_type == "single-service"

    - name: ğŸš€ DÃ©clenchement du CD GitHub Actions
      block:
        - name: ğŸ“ ParamÃ¨tres de dÃ©ploiement
          debug:
            msg: |
              ğŸ¯ DÃ©clenchement CD avec les paramÃ¨tres:
              - Type: {{ deployment_type }}
              - Service: {{ target_service }}
              - Environnement: {{ environment }}
              - Force recreate: {{ force_recreate }}
              - Workflow: helm-deploy.yml
              
        - name: ğŸš€ Lancement du workflow de dÃ©ploiement
          uri:
            url: "https://api.github.com/repos/{{ github_owner }}/{{ github_repo }}/actions/workflows/helm-deploy.yml/dispatches"
            method: POST
            headers:
              Authorization: "token {{ github_token }}"
              Accept: "application/vnd.github.v3+json"
              Content-Type: "application/json"
            body_format: json
            body:
              ref: "{{ github.branch }}"
              inputs:
                deployment_type: "{{ deployment_type }}"
                target_service: "{{ target_service }}"
                environment: "{{ environment }}"
                force_recreate: "{{ force_recreate | string | lower }}"
            status_code: 204
          register: workflow_dispatch
          
        - name: âœ… CD dÃ©clenchÃ© avec succÃ¨s
          debug:
            msg: |
              ğŸ‰ DÃ©ploiement Helm dÃ©clenchÃ© avec succÃ¨s!
              
              ğŸ“‹ Prochaines Ã©tapes:
              1. ğŸŒ Suivez le dÃ©ploiement: https://github.com/{{ github_owner }}/{{ github_repo }}/actions
              2. â³ Temps estimÃ©: 5-15 minutes selon les services
              3. ğŸ¯ Une fois terminÃ©, vÃ©rifiez: minikube dashboard
              4. ğŸ” VÃ©rification locale: kubectl get pods -A
              
              ğŸ”„ Pour redÃ©ployer: ansible-playbook ansible/minikube-cd-trigger.yml -e deployment_type={{ deployment_type }} -e target_service={{ target_service }}

  post_tasks:
    - name: ğŸ“Š Rapport de lancement CD
      debug:
        msg: |
          ğŸ“Š === RAPPORT LANCEMENT CD ===
          
          ğŸ—ï¸ Environnement:
          - Plateforme: {{ project_environment.platform }}
          - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          - Kubernetes: Minikube (actif)
          
          ğŸ¯ DÃ©ploiement configurÃ©:
          - Type: {{ deployment_type }}
          {% if deployment_type == "single-service" %}
          - Service: {{ target_service }}
          {% else %}
          - Services: Tous les services configurÃ©s
          {% endif %}
          - Environnement: {{ environment }}
          
          ğŸš€ Actions rÃ©alisÃ©es:
          - âœ… Validation environnement Minikube
          - âœ… Test connectivitÃ© GitHub
          - âœ… Validation du service cible
          - âœ… DÃ©clenchement workflow CD
          
          ğŸ“± Le dÃ©ploiement est en cours sur GitHub Actions!
          
    - name: ğŸ’¡ Commandes utiles post-dÃ©ploiement
      debug:
        msg: |
          ğŸ’¡ === COMMANDES UTILES ===
          
          ğŸ“Š Surveillance du dÃ©ploiement:
          - minikube dashboard
          - kubectl get pods -A
          - kubectl get svc -A
          - helm list -A
          
          ğŸ” Debug en cas de problÃ¨me:
          - kubectl describe pod POD_NAME -n NAMESPACE
          - kubectl logs POD_NAME -n NAMESPACE
          - helm status RELEASE_NAME -n NAMESPACE
          
          ğŸ”„ Gestion des dÃ©ploiements:
          - kubectl port-forward svc/SERVICE_NAME PORT:PORT -n NAMESPACE
          - helm rollback RELEASE_NAME REVISION -n NAMESPACE
