---
- name: ğŸš€ Deploy Helm Charts to Minikube
  hosts: localhost
  gather_facts: yes
  
  vars:
    # Chemins CORRIGÃ‰S - depuis le rÃ©pertoire racine du projet
    charts:
      - name: mysql
        path: ../database/mysql           # CORRIGÃ‰: ./ au lieu de ../
        namespace: mysql
        priority: 1
        
      - name: phpmyadmin
        path: ../database/phpmyadmin      # CORRIGÃ‰: ./ au lieu de ../
        namespace: phpmyadmin
        priority: 2
        
      - name: bind9
        path: ../bind9                    # CORRIGÃ‰: ./ au lieu de ../
        namespace: bind9
        priority: 3
        
      - name: unbound
        path: ../unbound                  # CORRIGÃ‰: ./ au lieu de ../
        namespace: unbound
        priority: 4
        
      - name: web-apache
        path: ../web-apache               # CORRIGÃ‰: ./ au lieu de ../
        namespace: web-apache
        priority: 5
        
      - name: web-nginx
        path: ../web-nginx                # CORRIGÃ‰: ./ au lieu de ../
        namespace: web-nginx
        priority: 6
        
      - name: email
        path: ../email                    # CORRIGÃ‰: ./ au lieu de ../
        namespace: email-stack
        priority: 7
        
      - name: monitoring
        path: ../monitoring/monitoring-chart  # CORRIGÃ‰: ./ au lieu de ../
        namespace: monitoring
        priority: 8

  pre_tasks:
    - name: ğŸ“‹ Informations de dÃ©ploiement
      debug:
        msg: |
          ğŸ¯ DÃ©marrage du dÃ©ploiement Helm Charts
          - RÃ©pertoire de travail: {{ ansible_env.PWD }}
          - Playbook depuis: {{ playbook_dir }}
          - Nombre de charts: {{ charts | length }}

  tasks:
    - name: ğŸ” Check Minikube status
      command: minikube status
      register: minikube_status
      changed_when: false
      failed_when: "'host: Running' not in minikube_status.stdout"

    - name: âœ… Minikube status OK
      debug:
        msg: |
          âœ… Minikube est actif et prÃªt
          {{ minikube_status.stdout_lines | join('\n') }}

    - name: ğŸ³ Set Minikube Docker environment
      shell: |
        source <(minikube docker-env)
        echo "DOCKER_HOST=$DOCKER_HOST"
      args:
        executable: /bin/bash
      changed_when: false
      register: docker_env

    - name: âœ… Validation des chemins des charts
      stat:
        path: "{{ item.path }}/Chart.yaml"
      register: chart_validation
      loop: "{{ charts }}"
      
    - name: âŒ VÃ©rification des charts manquants
      fail:
        msg: |
          âŒ Chart invalide dÃ©tectÃ©: {{ item.item.name }}
          Chemin testÃ©: {{ item.item.path }}/Chart.yaml
          RÃ©pertoire actuel: {{ ansible_env.PWD }}
          
          VÃ©rifiez que vous exÃ©cutez depuis le bon rÃ©pertoire:
          cd ~/helm-web-services-charts
          ansible-playbook ansible/minikube-cd-deploy.yml
      when: not item.stat.exists
      loop: "{{ chart_validation.results }}"

    - name: ğŸ“¦ Charts validÃ©s
      debug:
        msg: |
          ğŸ“¦ Tous les charts sont valides:
          {% for chart in charts %}
          - {{ chart.name }}: {{ chart.path }} â†’ {{ chart.namespace }}
          {% endfor %}

    - name: ğŸ—‚ï¸ Create namespaces
      kubernetes.core.k8s:
        api_version: v1
        kind: Namespace
        name: "{{ item.namespace }}"
        state: present
        definition:
          metadata:
            labels:
              app.kubernetes.io/managed-by: Helm
              environment: minikube
              project: helm-web-services
            annotations:
              meta.helm.sh/release-name: "{{ item.name }}"
              meta.helm.sh/release-namespace: "{{ item.namespace }}"
      loop: "{{ charts }}"

    - name: ğŸš€ Deploy Helm charts (by priority)
      kubernetes.core.helm:
        name: "{{ item.name }}"
        chart_ref: "{{ item.path }}"
        namespace: "{{ item.namespace }}"
        state: present
        create_namespace: true
        wait: true
        wait_timeout: "600s"
      loop: "{{ charts | sort(attribute='priority') }}"
      register: helm_results

    - name: ğŸ“Š RÃ©sumÃ© des dÃ©ploiements
      debug:
        msg: |
          ğŸ“Š DÃ©ploiements Helm:
          {% for result in helm_results.results %}
          - {{ result.item.name }}: {{ 'âœ… InstallÃ©' if result.changed else 'âœ… DÃ©jÃ  Ã  jour' }}
          {% endfor %}

    - name: â³ Attendre la disponibilitÃ© des pods
      pause:
        seconds: 30
        prompt: "Attente du dÃ©marrage des pods..."

    - name: ğŸ” Verify deployments
      command: kubectl get pods --namespace {{ item.namespace }} -o wide
      loop: "{{ charts }}"
      register: pod_status
      changed_when: false
      failed_when: false

    - name: ğŸ“Š Display pod status
      debug:
        msg: |
          ğŸ“Š Pods dans {{ item.item.namespace }}:
          {{ item.stdout_lines | join('\n') }}
      loop: "{{ pod_status.results }}"

  post_tasks:
    - name: ğŸ‰ DÃ©ploiement terminÃ©
      debug:
        msg: |
          ğŸ‰ === DÃ‰PLOIEMENT RÃ‰USSI ===
          
          ğŸ“¦ {{ charts | length }} charts dÃ©ployÃ©s sur Minikube
          ğŸ¯ Namespaces: {{ charts | map(attribute='namespace') | list | join(', ') }}
          
          ğŸ” Commandes utiles:
          - kubectl get pods --all-namespaces
          - kubectl get services --all-namespaces
          - minikube service list
          - minikube dashboard
          
          ğŸ“Š Monitoring:
          kubectl port-forward -n monitoring svc/grafana 3000:3000
          kubectl port-forward -n monitoring svc/prometheus 9090:9090